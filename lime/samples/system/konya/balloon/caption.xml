<?xml version="1.0" encoding="EUC-JP" ?>
<?bml bml-version="100.0" ?>

<bml>
<head>
<title>Paralinguistic Caption Test: Konya</title>

<?php
	$ip = getenv('REMOTE_ADDR');

	if( preg_match( "/[0-1a-fA-f]*:[0-1a-fA-f]*/", $ip ) )
	{
		$proto = "rtp_tts";
	}
	else
	{
		$proto = "http_tts";
	}
?>

<style><![CDATA[
	
	.button {width:140px;height:32px;}
	p:focus {background-color-index:82;}
	p.button {text-align:center;color-index:0;line-height:30px;}
	
	.balloonpng {left:5px;top:5px;width:270px;height:140px;}
.bbase {width:560px;height:410px;position:absolute;}
p.subtitle{left:10px; top:10px;width:250px;height:140px;line-height:18px;font-size:20px;position:absolute;}

#posBalloon {left:336px;top:194px;}


	#display	{color-index:1;text-align:left;padding-top:5px;padding-left:5px;padding-right:5px;padding-bottom:5px;font-size:24px;
	top:10px;height:126px;width:700px;}
	
	
	

	#caption	{left:15px; top:25px;width:250px;height:140px;line-height:18px;font-size:20px;position:absolute;}
	
	
]]></style>


<script><![CDATA[

var adj_delay = 50;
var origin;
var cnt = 0;
var CounterID = NaN;
var tArr = Array();
var lNum= Number();
var fSize;
var tWidth=200;
var cID='ZT1_LIME_TEST';


var yUnit = 135;/* (ie. 540/4)*/
var xUnit = 240;/* (i.e. 960/4)*/

origin = new Date();

var vHost = '175.41.244.154';
//var pHost = '175.41.243.162'; /* ASTEM Talk £ö€h£Ð¥¢¥É¥ì¥¹£ó"¡¦B */
//var pHost = '[2001:e38:0:502::100]:9010'; /* ASTEM Talk £ö€h£Ð¥¢¥É¥ì¥¹£ó"¡¦B */
var pHost = 'lime.jgn-x.jp:9010'; /* ASTEM Talk £ö€h£Ð¥¢¥É¥ì¥¹£ó"¡¦B */
//var pHost = '202.180.38.226:9010'; /* ASTEM Talk £ö€h£Ð¥¢¥É¥ì¥¹£ó"¡¦B */

var obj = document.getElementById("display");
var cap = document.getElementById("caption");




var lg = document.getElementById("clang");/* for debugging */
lg.firstChild.data = cID;
           

function setBalloon(para){

var cRN = document.getElementById("Rn").normalStyle;
var cLN = document.getElementById("Ln").normalStyle;
var cRE = document.getElementById("Re").normalStyle;
var cLE=  document.getElementById("Le").normalStyle;
var cND=  document.getElementById("Nd").normalStyle;


if (para == "Rn") {
cRN.visibility="visible";
cLN.visibility="hidden";
cRE.visibility="hidden";
cLE.visibility="hidden";
cND.visibility="hidden";
}
else if (para == "Ln") 
{cRN.visibility="hidden";
cLN.visibility="visible";
cRE.visibility="hidden";
cLE.visibility="hidden";
cND.visibility="hidden";}
else if (para == "Re") 
{cRN.visibility="hidden";
cLN.visibility="hidden";
cRE.visibility="visible";
cLE.visibility="hidden";
cND.visibility="hidden";}
else if (para == "Le") {
cRN.visibility="hidden";
cLN.visibility="hidden";
cRE.visibility="hidden";
cLE.visibility="visible";
cND.visibility="hidden";}
else {cRN.visibility="hidden";
cLN.visibility="hidden";
cRE.visibility="hidden";
cLE.visibility="hidden";
cND.visibility="visible";}
}



/* Positions


11¡¡12¡¡13¡¡14
21¡¡22¡¡23¡¡24
31¡¡32¡¡33¡¡34
41¡¡42¡¡43¡¡44


135px per y-pos; 240 per x-pos

11 -> top:0px; left:0px  12 -> top:0px; left:240px
21 -> top:135px; left:0px

pos(yx) = top:(y-1)*135 px;left:(x-1)*240 px;
i.e. top:(y-1)*yUnit px;left:(x-1)*xUnit px;

document.getElementById(LocID).normalStyle.top= top:(y-1)*yUnit;
document.getElementById(LocID).normalStyle.left= left:(x-1)*xUnit;

where 
var yUnit = 135; (ie. 540/4)
var xUnit= 240; (i.e. 960/4)


function putBalloon(cLoc){
	var lpos = cLoc.split("")[0];
	var rpos = cLoc.split("")[1];

bPos.top= (lpos-1)*yUnit;
bPos.left= (rpos-1)*xUnit;

}

*/

var url4 = "http://"+ pHost +"/eucconvert2.php";
var url5 = "http://119.245.149.40/index.html"; /*iio */
var url6 ="http://192.168.1.6/limeDemo/konya/data/"; /* konya*/


function alert(str)
{
	obj.firstChild.data = str+"\r\n" ;
}


function showCaption(str)
{
	cap.firstChild.data = str+"\r\n" ;
}


function startCounter()
{
	browser.sleep(adj_delay);

	if(!isNaN(CounterID))
	{
		browser.clearTimer(CounterID);
	}
	else
	{	
		CounterID = browser.setInterval("changeText();", 1000, 0);
		/*changeText();*/
	}
}


function chgID(){

if(cID=="ZT1_LIME_TEST") {cID="ZT1_SNOWFES_JP";}else{cID="ZT1_LIME_TEST";}
/*lg.firstChild.data = cID;*/
}


function putBalloon(cLoc){
var bPos= document.getElementById("posBalloon").normalStyle;
	var lpos = cLoc.split("")[0];
	var rpos = cLoc.split("")[1];

bPos.top= (lpos-1)*yUnit +"px";
bPos.left= (rpos-1)*xUnit +"px";

}


function formatTime(num){
var mmin = num/60;

 if (mmin>9){min=mmin;}else{min="0"+mmin;};
 
var ssec =num%60;

 if (ssec>9){sec=ssec;}else{sec="0"+ssec;};

var myTime="00:"+min+":"+sec;

return myTime;}

/*
function makeSeconds(time){

var t = time.split(":");
t[0]; hour
t[1]; minutes 
t[2]; seconds 

return(t[1]*60 + t[2]*1); 

}*/


function changeText()
{ 


var now = new Date();

var pos=browser.subDate(now,origin,1);

alert("current time "+formatTime(pos));



	fSize=parseInt(obj.normalStyle.fontSize);

	var ret = browser.transmitTextDataOverIP(url6 + cnt + ".txt","","EUC-JP");

	var msg =ret[2];
	var txt = ret[2];
	var tField = msg.split("\t");
	
	/*
	tField[0] = id
	tField[1] = start
	tField[2] = end
	tField[3] = location
	tField[4] = orientation
	tField[5] = emotion
	tField[6] = text
		
	*/
	
	var cStart =tField[1];
	var cLoc=tField[3];
	var cDir = tField[4];
	var cEmo= tField[5];
	var cPos =cDir.toString()+cEmo.toString();
	
	putBalloon(cLoc);
	msg=tField[6].split('"');
		
	tArr= txt.split('\n');
	tPos = txt.indexOf('\n');
	tTailLen= txt.length - tPos;
	lNum = tArr.length;
	
	
	if(tPos >0)
	{
		if(tTailLen>tPos)
		{
			tLen=tTailLen * fSize;
		}
		else
		{
			tLen=tPos *fSize;
		}
	}
	else
	{
		tLen=0;
	}

	tWidth= cID=="ZT1_LIME_TEST" ? (tLen +10)/2 :(tLen +10);	

	if( ret[0] == 1 )
	{
		if (tPos <= 0)
		{
			obj.normalStyle.backgroundColorIndex = 8;
		}
		else if (lNum <3)
		{
			obj.normalStyle.backgroundColorIndex = 8;
			obj.normalStyle.width= tWidth;
			obj.normalStyle.left = 200;    
			obj.normalStyle.height=fSize+10;
		}
		else
		{  
			obj.normalStyle.backgroundColorIndex = 8;
			obj.normalStyle.width= tWidth;
			obj.normalStyle.left = 200; 
			obj.normalStyle.height=fSize*2+10;
		}
       
        showCaption(msg+"\n"+cStart);
       setBalloon(cPos);
        
		/*alert("foo"+ msg);*/
	
	}
	else
	{
		alert("Transmission failed"+cnt+" E:"+ret[0]);
	}
	cnt++;
}



function handler()
{
	var evt = document.currentEvent;
	var kcode =evt.keyCode;
	
	if (kcode == 19){goback();}
	else if (keycode == 22){}
	else if (keycode == 23){obj.normalStyle.fontSize=30;}
	else if (keycode == 24){obj.normalStyle.fontSize=36;}
}

//function goback(){ browser.launchDocument("../startup.xml", "cut");	}
function goback(){ browser.launchDocument("http://eric-brechemier.github.com/lime-iptv-portal/bml/startup.bml", "cut");	}

function chgSmall(){ obj.normalStyle.fontSize=24;}
function chgMedium(){obj.normalStyle.fontSize=30;}
function chgLarge(){ obj.normalStyle.fontSize=36;}


]]></script>

</head>
<body onload="startCounter();" style="background-color-index:7;">

<!---
==================================================================
·î-¡¦@hls.okimediaserver.com¡¡¤ê¿î¹ñ£æ"¡¦Ãà§àçàÛà¡¦B
¡¡lime.jgn-x.jp¡¡Æâ€¡¦ËáA¥É¥ì¥¹£ó€t£Ò£Ì£õ5¡¦X£ä°æ€¡à¡¦¡¦Ûà¡¦¡¦¡¦¡¦¡¦¡¦H
¡¡
¡¡¡¡JGN-X ¥¯¥é¥¦¥É¥µ¡¼¥Ð£öGP¾éÆë"
        IPv4¡§202.180.39.202
        IPv6¡§2001:e38:0:502::100

==================================================================
-->
	<div style="top:0px;left:0px;width:960px;height:540px;visibility:visible;">
		<object id="vod" type="application/X-arib-contentPlayControl" data="http://hls.okimediaserver.com/pcs/resolvecontent?contents_path=/moviebox/snow-festa/yoursingapore_out.mp4&protocol=http_tts" streamstatus="play" style="top:0px;left:0px;width:960px;height:540px;" />
	</div>
	
<!-- balloons -->

<div id="posBalloon" class="bbase" >



<object id="Le" class="balloonpng" style="visibility:hidden" type="image/X-arib-png" data="balloon4L.png"></object>


<object id="Re" class="balloonpng"  style="visibility:hidden" type="image/X-arib-png" data="balloon4R.png"></object>



<object id="Nd" class="balloonpng" style="visibility:hidden" type="image/X-arib-png" data="balloon5R.png"></object>



<object class="balloonpng" style="visibility:hidden" type="image/X-arib-png" data="balloon5L.png"></object>



<object id="Rn" class="balloonpng" type="image/X-arib-png" data="balloon3R.png" style="visibility:hidden"></object>


<object id="Ln" class="balloonpng"style="visibility:hidden" type="image/X-arib-png" data="balloon3L.png"></object>



			<p id="caption"  class="subtitle"><![CDATA[]]></p>
	</div>
	<!-- buttons -->
	
<p class="button" style="top:1px;left:1px;height:1px;width:1px;color-index:3;font-size:24pt;" accesskey="B" onclick="goback();"></p>

<p class="button" id="clang" style="top:10px;left:10px;height:36px;width:1px;color-index:1;font-size:24pt;" accesskey="R" onclick="chgID();"><![CDATA[]]></p>

<p class="button" style="top:10px;left:74px;height:36px;width:1px;color-index:2;font-size:24pt;" accesskey="G"  onclick="chgSmall();"></p>

<p class="button" style="top:10px;left:138px;height:36px;width:1px;color-index:3;font-size:24pt;" accesskey="Y" onclick="chgLarge();"></p>

<p style="top:0px;left:0px;height:1px;width:1px;background-color-index:8;nav-index:0;" onkeydown="handler();" onkeyup="handler();" onclick="handler();"><![CDATA[]]></p>



<p id="display" style="left:10px;background-color-index:8;"><![CDATA[]]></p>

</body>
</bml>

