<?xml version="1.0" encoding="EUC-JP"?>
<!DOCTYPE bml PUBLIC "-//ARIB STD-B24:1999//DTD BML Document for IPTV//JA" "http://www.arib.or.jp/B24/DTD/bml_x_x_iptv.dtd">
<?bml bml-version="100.0" ?>

<bml>
<head>
<title>aIPTV</title>
<style><![CDATA[
	body{
		clut:url(../images/default.clt);
	}

       #display	{ font-size:20px;  background-color-index:16; color-index:7;font-size:16px;top:400px;left:460px;width:480px;height:440px;}

]]></style>
<script src="../scripts/common.ecm"/>
<script src="../scripts/xparse.ecm"/>
<script src="../scripts/mycommon.ecm"/> <!-- added by Kawamori -->
<script><![CDATA[


var offset;
var origin;

var vodTimerID = NaN;
var fullscreenFlag = 0;
var captionSelectFlag = 0;

function onload(){
	browser.lockScreen();

	// XMLファイルの読み込み
	loadXML(gCaptionXML_bad, gCaption_bad);
	loadXML(gCaptionXML_good, gCaption_good);


	var video = getElementById("video");
	video.data = gVodURL;
	showElem("video");

	var captionMode = getElementById("captionMode");
	captionMode.firstChild.data = "変換処理OFF";

	browser.unlockScreen();

	hideElem("loading");

	video.streamStatus="play";

  origin = new Date();

  offset=30;

	if( !isNaN(vodTimerID) ){
		browser.clearTimer(vodTimerID);
		vodTimerID = NaN;
	}

	vodTimerID = browser.setInterval("checkTime();", 500, 0);
}

function onunload(){
	var video = getElementById("video");
	video.streamStatus="stop";
	if( !isNaN(vodTimerID) ){
		browser.clearTimer(vodTimerID);
		vodTimerID = NaN;
	}
}

function checkTime(){

var video = getElementById("video");

// added by Kawamori
var now = new Date();

var pos=parseInt(browser.subDate(now,origin,0))/100;
	
 var myStreamPosition = pos; 

	if (gVodLength-2 <= myStreamPosition) {
		video.streamStatus="stop";
		video.data = gVodURL;
		video.streamStatus="play";
	}


	// 字幕選択フラグにより表示する字幕を切り替える
	var captionArray;
	if (captionSelectFlag == 0){
		captionArray = gCaption_bad;
	} else {
		captionArray = gCaption_good;
	}

	var caption = getElementById("caption");
	var caption_full = getElementById("caption_full");
	var i=0;
	var flag = 0;	// captionフラグ

	for (i=0; i < captionArray.length; i++) {

		if ((Number(captionArray[i][1])) <= myStreamPosition*100 && (Number(captionArray[i][0])) >= myStreamPosition*100) { 

			caption.firstChild.data = "["+captionArray[i][2]+"]";
			caption_full.firstChild.data = "[["+captionArray[i][2]+"]]";
			flag = 1;
			break;
		}
	}
	if (flag == 0) {
		caption.firstChild.data = "--";
		caption_full.firstChild.data = "--------"; 
	}
}

function keydown(){
	var keyCode = String(document.currentEvent.keyCode);

	if (keyCode == "19") {
		// back key
	} else if (keyCode == "21") {
		// blue key
		browser.lockScreen();
		var video = getElementById("video");
		var caption = getElementById("caption");
		var caption_full = getElementById("caption_full");
		if (fullscreenFlag == 1) {
			// ビデオ表示サイズ縮小
			video.normalStyle.left = "5";
			video.normalStyle.top = "55";
			video.normalStyle.width = "624";
			video.normalStyle.height = "351";

			caption_full.normalStyle.visibility = "hidden";
			caption.normalStyle.visibility = "visible";
			fullscreenFlag = 0;
		} else {
			// ビデオフルスクリーン化
			video.normalStyle.left = "0";
			video.normalStyle.top = "0";
			video.normalStyle.width = "960";
			video.normalStyle.height = "540";

			caption.normalStyle.visibility = "hidden";
			caption_full.normalStyle.visibility = "visible";
			fullscreenFlag = 1;
		}
		browser.unlockScreen();
	} else if (keyCode == "22") {
		// red key
		var captionMode = getElementById("captionMode");
		if (captionSelectFlag == 0) {
			captionSelectFlag = 1;
			captionMode.firstChild.data = "変換処理ON";
		} else {
			captionSelectFlag = 0;
			captionMode.firstChild.data = "変換処理OFF";
		}
	} else if (keyCode == "23") {
		// green key
		// Unimplemented
	} else if (keyCode == "24") {
		// yellow key
		// Unimplemented
	}
}

function dataKey(){
		// Unimplemented
}

]]></script>


<bevent>
	<beitem id="top" type="DataButtonPressed" onoccur="dataKey();" subscribe="subscribe" />
</bevent>

</head>
<body id="body" style="used-key-list:basic data-button numeric-tuning;" onload="onload();" onunload="onunload();">
<div id="basebox" style="width:960px;height:540px;background-color-index:30">
<!-- modified by Kawamori for Aquos Jan. 2 2012-->

        <object id="bg" type="image/X-arib-png" data="../images/bg.png"  style="left:0px; top:0px; width:960px; height:540px; nav-index:0;" onkeydown="keydown();"/>
        <object id="colorButton_B" type="image/X-arib-png" data="../images/ColorButton_01.png" style="left:5px; top:510px; width:100px; height:25px;" />
	<object id="colorButton_R"  type="image/X-arib-png" data="../images/ColorButton_02.png" style="left:110px; top:510px; width:100px; height:25px;" />
	<object id="colorButton_G"  type="image/X-arib-png" data="../images/ColorButton_03.png" style="left:215px; top:510px; width:100px; height:25px;" />
	<object id="colorButton_Y"  type="image/X-arib-png" data="../images/ColorButton_04.png" style="left:320px; top:510px; width:100px; height:25px;" />


<!--
	<object id="bg" type="image/jpeg" data="../images/bg.jpg" style="left:0px; top:0px; width:960px; height:540px; nav-index:0;" onkeydown="keydown();" />

	<object id="colorButton_B" type="image/jpeg" data="../images/ColorButton_01.jpg" style="left:5px; top:510px; width:100px; height:25px;" />
	<object id="colorButton_R" type="image/jpeg" data="../images/ColorButton_02.jpg" style="left:110px; top:510px; width:100px; height:25px;" />
	<object id="colorButton_G" type="image/jpeg" data="../images/ColorButton_03.jpg" style="left:215px; top:510px; width:100px; height:25px;" />
	<object id="colorButton_Y" type="image/jpeg" data="../images/ColorButton_04.jpg" style="left:320px; top:510px; width:100px; height:25px;" />
-->
	<p id="colorButton_B_caption" style="font-size:16px; color-index:7; grayscale-color-index:7 72; text-align:center; left:5px; top:513px; width:100px; height:16px;">Full</p>
	<p id="colorButton_R_caption" style="font-size:16px; color-index:7; grayscale-color-index:7 72; text-align:center; left:110px; top:513px; width:100px; height:16px;">変換ON/OFF</p>

	<p id="captionMode" style="font-size:16px; color-index:7; grayscale-color-index:7 72; text-align:center; left:800px; top:513px; width:150px; height:16px;"><![CDATA[ ]]></p> <!-- modified by Kawamori-->


	<!-- ビデオと字幕をボタン類より上に表示させるためにボタン類より後ろで定義 -->

	<object id="video" type="application/X-arib-contentPlayControl" data="" style="left:5px;top:55px;width:624px;height:351px;visibility:hidden;" streamstatus="stop" />
	<p id="caption" style="font-size:16px; color-index:0; grayscale-color-index:0 65; text-align:center; left:5px; top:415px; width:624px; height:25px; visibility:visible"><![CDATA[]]></p>
	<p id="caption_full" style="font-size:30px; color-index:7; grayscale-color-index:7 72; text-align:center; left:0px; top:500px; width:960px; height:40px; visibility:hidden"><![CDATA[]]></p>

	<object id="loading" type="image/X-arib-png" data="../images/NowLoading.jpg" style="left:0px; top:237px; width:960px; height:65px; visibility:visible"/>


</div>
<!--
 <p id="display" style=""><![CDATA[]]></p>
-->
</body>
</bml>
