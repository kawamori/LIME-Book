/**
 * ECMAScriptAPI
============================================================
Copyright (C)2009, NTT Plala Inc. All rights reserved.
Copyright(C) Nippon Telegraph and Telephone Corporation 2010
============================================================
 * 
 * 2009/04/24
 * version 3.0.0
 */

/**
 * 【スタブ用】TSVの配置場所へのパス
 */
var STUB_PATH = "http://localhost/fdn-e_3.0/tsv/";

// 各画面のコンテンツ数
var PARADE_NUM_PER_PAGE = 5;
var VOD_LIST_NUM_PER_PAGE = 9;
var TV_SERIES_LIST_NUM_PER_PAGE = 5;
var TV_CHANNEL_LIST_NUM_PER_PAGE = 15;
var ANNO_LIST_NUM_PER_PAGE = 9;
var ACTIVE_CHANNELS_LIST_NUM_PER_PAGE = 9;
var BUY_LIST_VOD_NUM_PER_PAGE = 9;
var ACTIVE_LIST_VOD_NUM_PER_PAGE = 9;
var ACTIVE_LIST_PREMIUM_NUM_PER_PAGE = 9;

var TV_PACK_MEMBER_NUM_PER_PAGE = 9;
var BOOKMARK_LIST_VOD_NUM_PER_PAGE = 9;
var PLAN_LIST_NUM_PER_PAGE = 9;
var PREMIUM_LIST_NUM_PER_PAGE = 9;
var PREMIUM_SVOD_MEMBER_NUM_PER_PAGE = 9;
var PREMIUM_SVODCOMPLEX_MEMBER_NUM_PER_PAGE = 9;

// スタブ用定数定義
var REMOVE_SIGNATURE="abcdeaaaaaaaaaaaaaaaaaaaa=";
var REMOVE_CERTIFICATES_URL="http://aaaa";
var REMOVE_DRM_SERVER_URL="http://aaaa";

// カラオケ用定数定義（PER_PAGE）
var KARAOKE_LIST_NUM_PER_PAGE = 9;
var KARAOKE_GIT_LIST_NUM_PER_PAGE = 9;
var KARAOKE_ARTIST_LIST_NUM_PER_PAGE = 9;
var KARAOKE_BY_ARTIST_LIST_NUM_PER_PAGE = 9;
var KARAOKE_BY_TITLE_LIST_NUM_PER_PAGE = 9;

var KARAOKE_RESERVATION_LIST_NUM_PER_PAGE = 9;
var KARAOKE_QUEUE_NUM_PER_PAGE = 2;
var KARAOKE_HISTORY_LIST_NUM_PER_PAGE = 9;

// スタブTSVのコンテンツ総数
var VOD_CONTENT_TOTAL = 18;
var VOD_IDLIST_TOTAL = 6;
var VOD_RELATED_CONTENT_TOTAL = 18;
var ANNOUNCEMENT_TOTAL = 56;
var TV_CONTENT_TOTAL = 42;
var CHSVOD_CONTENT_TOTAL = 60;
var CHANNEL_TOTAL = 30;
var PREMIUM_1_TOTAL = 42;
var PREMIUM_2_TOTAL = 14;
var PREMIUM_3_TOTAL = 4;
var PREMIUM_4_TOTAL = 7;
var HOME_PARADE_TOTAL = 129;
var VOD_PARADE_TOTAL = 16;
var TV_PARADE_TOTAL = 69;
var MEMBER_OF_WIZARD_TOTAL = 5;
var MEMBER_OF_VOD_TOTAL = 6;
var TV_SERIES_TOTAL = 8;
var MAINTENANCES_TOTAL = 10;
var SUPPORTS_TOTAL = 12;
var NEW_ANNO_TOTAL = 10;
var MEMBER_OF_CHSVOD_TOTAL = 8;
var ACTIVE_CHANNELS_TOTAL = 30;
var BUY_LIST_0_TOTAL = 18;
var BUY_LIST_1_TOTAL = 18;
var BUY_LIST_2_TOTAL = 18;
var ACTIVE_LIST_VOD_TOTAL = 26;
var ACTIVE_LIST_PREMIUM_TOTAL = 60;
var KARAOKE_CONTENT_TOTAL = 11;
var KARAOKE_GIT_CONTENT_TOTAL = 12;
var KARAOKE_BY_ARTIST_TOTAL = 11;
var KARAOKE_BY_TITLE_TOTAL = 11;
var MEMBER_OF_KARAOKE_TOTAL = 11;
var KARAOKE_ARTIST_TOTAL = 27;
var KARAOKE_PARADE_TOTAL = 12;
var NOD_PARADE_TOTAL = 12;
var NOD_WIZARD_CONTENT_TOTAL = 6;
var ANNO_SUPPORTS_TOTAL = 24;

// STEP2.0 カラオケ用定数
var KARAOKE_RESERVATION_LIST_LIMIT = 11;
var KARAOKE_PARADE_TOTAL = 12;

// STEP2.0 カラオケ予約用配列
var kQueue = new Array();

// STEP2.5 ブックマーク用配列
var bQueue = new Array();

// NOD　トップパレード取得用ジャンル文字列定義
var GENRE_NOD_TOP_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:7.1";

// NOD　wizardGit取得用ジャンル文字列定義
var GENRE_NOD_REPEAT_WIZARD_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:7.2.1";
var GENRE_NOD_NEWS_WIZARD_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:7.3.1";

// NOD　お知らせ取得用ジャンル文字列定義
var GENRE_NOD_ANNO_ABOUT_NOD = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:7.6.1";
var GENRE_NOD_ANNO_FAQ = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:7.6.2";
var GENRE_NOD_ANNO_HELP = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:7.6.3";

// NOD　extraObject用定数定義
var EO_KEY_NOD = "EO_KEY_NOD";
var EO_KEY_REGULATION_URL = "EO_KEY_REGULATION_URL";


//////////////////////////  オブジェクト定義  /////////////////////////////////

/**
 * コンテンツ（PIT，GIT）の情報を保持します．
 *
 * @param crid CRID [or BLANK]
 * @param displayType コンテンツのdisplayTypeCS値 [or null]
 * @param basicDescription 基本情報（BasicDescription参照） [or null]
 * @param icon アイコン情報（Icon参照） [or null]
 * @param period 期間情報（Period参照） [or null]
 * @param contentDetail 詳細情報（ContentDetail参照） [or null]
 * @param sort ソートキー（パックの場合のみ） [or BLANK]
 * @param broadCastEvent TV情報（BroadCastEvent参照）
 *
 * ※DisplayTypeの種類
 * tv_program              // 番組紹介型
 * tv_channel              // チャンネル紹介型
 * video_program           // 作品紹介
 * karaoke_program         // 曲紹介型
 * announcement            // お知らせ・サポート型
 * channel_package         // チャンネルパック型
 * video_package           // パック
 * karaoke_package         // カラオケパック型
 * subscription_package    // 見放題
 * series_svod             // 見放題
 * channel_svod            // チャンネルSVOD型
 * tv_programs_promotion   // 番組シリーズ詳細型
 * video_series            // シリーズ
 * sheet                   // シート
 * karaoke_series          // カラオケ曲リスト型
 * wizard                  // ウィザード型
 * parade                  // パレード型
 * related_programs        // 関連作品
 * karaoke_artist_results  // カラオケ歌手検索結果
 * karaoke_song_results    // カラオケ曲検索結果
 * reservation             // 視聴予約詳細
 * maintenance             // メンテナンス
 */
function ContentInformation (crid, displayType, basicDescription,
                                    icon, period, contentDetail, sort,
                                    broadCastEvent) {
  this.crid = crid;
  this.displayType = displayType;
  this.basicDescription = basicDescription;
  this.icon = icon;
  this.period = period;
  this.contentDetail = contentDetail;
  this.sort = sort;
  this.broadCastEvent = broadCastEvent;
  this.extraObject = new Object();
}

/**
 * コンテンツ詳細情報を保持します．
 *
 * @param demoNG デモ不可 1 それ以外は 0
 * @param hasRelated 関連コンテンツがあれば 1 それ以外は 0
 * @param announcementType お知らせタイプ 新着 1 サポート 2 メンテナンス 3
 *                         それ以外 0
 * @param activeLicense 視聴可能ライセンス（ActiveLicense参照） [or null]
 * @param purchaseLicense 単品購入情報配列（PurchaseLicense参照） [or null]
 * @param packPurchaseLicense パック購入情報配列（PurchaseLicense参照） [or null]
 * @param announcementRelatedCrid 詳細ボタン押下時の関連CRID（お知らせの場合のみ） [or BLANK]
 * @param cid コンテンツID [or BLANK]
 * @param stopposition 再生停止位置[or BLANK]
 */
function ContentDetail (demoNG, hasRelated, announcementType, activeLicense, purchaseLicense,
                          packPurchaseLicense, announcementRelatedCrid, cid, stopposition) {
  this.demoNG = demoNG;
  this.hasRelated = hasRelated;
  this.announcementType = announcementType;
  this.activeLicense = activeLicense;
  this.purchaseLicense = purchaseLicense; // 配列
  this.packPurchaseLicense = packPurchaseLicense; // 配列
  this.announcementRelatedCrid = announcementRelatedCrid;
  this.cid = cid;
  this.stopposition = stopposition;
}

/**
 * 基本情報を保持します．
 *
 * @param title タイトル [or BLANK]
 * @param synopsis 詳細説明文 [or BLANK]
 * @param thumbLarge サムネイル大URL [or BLANK]
 * @param thumbMiddle サムネイル中URL [or BLANK]
 * @param thumbSmall サムネイル小URL [or BLANK]
 * @param trailer トレーラーのURL [or BLANK]
 * @param isAdult アダルトコンテンツなら1 それ以外 0
 * @param parentalRate R/PG 指定の年齢数 （0-20）Gの場合は0
 * @param copyrightImage サムネイルのコピーライト [or BLANK]
 * @param copyrightTrailer トレーラーのコピーライト [or BLANK]
 * @param rValue R/PG付きの指定年齢数[or BLANK]
 */
function BasicDescription (title, synopsis, thumbLarge,
                               thumbMiddle, thumbSmall, trailer, isAdult,
                                parentalRate, copyrightImage, copyrightTrailer, rValue) {
  this.title = title;
  this.synopsis = synopsis;
  this.thumbLarge = thumbLarge;
  this.thumbMiddle = thumbMiddle;
  this.thumbSmall = thumbSmall;
  this.trailer = trailer;
  this.isAdult = isAdult;
  this.parentalRate = parentalRate;
  this.copyrightImage = copyrightImage;
  this.copyrightTrailer = copyrightTrailer;
  this.rValue = rValue;
}

/**
 * アイコンに関する情報を保持します．
 *
 * 注 意事項：
 * ・パレンタルロック，成人アイコンの表示はparental値から識別する．
 * ・配信ステータスのX/Yはavailability値から生成する．
 * @param hd [VOD/TV] ハイビジョンなら 1 それ以外は 0
 * @param caption [VOD/TV] 字幕なら 1 それ以外は 0
 * @param multi [VOD/TV] 多重音声なら 1 5.1chなら 2 それ以外は 0
 * @param copy [VOD/TV] コピーネバー 1 コピーワンス 2 コピーフリー 3 それ以外 0
 * @param purchase [VOD/TV] 購入要 1 それ以外 0
 * @param basic [VOD] 基本見放題プランで見放題期間内なら 1 基本見放題プランで見放題期間外なら 2 それ以外は 0
 * @param option [VOD] オプションプランなら プランアイコン画像URL それ以外は BLANK
 * @param free [VOD] 無料なら 1 それ以外は 0
 * @param delivery [VOD] 配信中 1 配信予定 2 配信停止 3 配信終了 4 それ以外 0
 * @param series [VOD] シリーズ 1 それ以外 0
 * @param ppv [TV] PPVなら 1 それ以外 0
 */
function Icon(hd, caption, multi,
                          copy, purchase, basic, option, free, delivery,
                          series, ppv) {
  this.hd = hd;
  this.caption = caption;
  this.multi = multi;
  this.copy = copy;
  this.purchase = purchase;
  this.basic = basic;
  this.option = option;
  this.free = free;
  this.delivery = delivery;
  this.series = series;
  this.ppv = ppv;
}

/**
 * 期間情報を保持します．
 *
 * @param displayStart 表示可能開始(DateArray) [or null]
 * @param displayEnd 表示可能終了(DateArray) [or null]
 * @param availabilityStart 利用可能開始(DateArray) [or null]
 * @param availabilityEnd 利用可能終了(DateArray) [or null]
 * @param newArrivalStart 新着開始(DateArray) [or null]
 * @param newArrivalEnd 新着終了(DateArray) [or null]
 * @param premiumStart 新作開始(DateArray) [or null]
 * @param premiumEnd 新作終了(DateArray) [or null]
 * @param comingEndStart 終了間近開始(DateArray) [or null]
 * @param comingEndEnd 終了間近終了(DateArray) [or null]
 * @param publishedStart 放送開始(DateArray) [or null]
 * @param publishedEnd 放送終了(DateArray) [or null]
 */
function Period(displayStart, displayEnd, availabilityStart, availabilityEnd,
                 newArrivalStart, newArrivalEnd, premiumStart, premiumEnd,
                 comingEndStart, comingEndEnd, publishedStart, publishedEnd) {
  this.displayStart = displayStart;
  this.displayEnd = displayEnd;
  this.availabilityStart = availabilityStart;
  this.availabilityEnd = availabilityEnd;
  this.newArrivalStart = newArrivalStart;
  this.newArrivalEnd = newArrivalEnd;
  this.premiumStart = premiumStart;
  this.premiumEnd = premiumEnd;
  this.comingEndStart = comingEndStart;
  this.comingEndEnd = comingEndEnd;
  this.publishedStart = publishedStart;
  this.publishedEnd = publishedEnd;
}


/**
 * 商品，ライセンス情報を保持します．
 *
 * @param name 商品表示名 [or BLANK]
 * @param licenseId ライセンスID [or BLANK]
 * @param purchaseId 商品ID [or BLANK]
 * @param price 価格
 * @param quantityRange 利用期間 （数値）
 * @param quantityUnit 利用期間単位 (日，月，週間などの表示文字) [or BLANK]
 * @param validityIntervalStart ライセンス有効開始（DatArraye） [or null]
 * @param validityIntervalEnd ライセンス有効終了（DateArray） [or null]
 * @param purchaseStart 配信開始（DateArray） [or null]
 * @param purchaseEnd 配信終了（DateArray） [or null]
 * @param crid パックの場合のGITのCRID [or BLANK]
 * @param displayType パックの場合のGITのdisplayType [or BLANK]
 * @param licenseType ライセンス種別 [or BLANK]
 * @param vzone Vゾーンの場合：1, それ以外：0
 * @param purchaseDate 購入日（DateArray） [or null]
 */
function PurchaseLicense(name, licenseId, purchaseId, price, quantityRange, quantityUnit,
                           validityIntervalStart, validityIntervalEnd, purchaseStart, purchaseEnd,
                           crid, displayType, licenseType, vzone, purchaseDate) {
  this.name = name;
  this.licenseId = licenseId;
  this.purchaseId = purchaseId;
  this.price = price;
  this.quantityRange = quantityRange;
  this.quantityUnit = quantityUnit;
  this.validityIntervalStart = validityIntervalStart;
  this.validityIntervalEnd = validityIntervalEnd;
  this.purchaseStart = purchaseStart;
  this.purchaseEnd = purchaseEnd;
  this.crid = crid;
  this.displayType = displayType;
  this.licenseType = licenseType;
  this.vzone = vzone;
  this.purchaseDate = purchaseDate;
}

/**
 * 視聴可能ライセンスの情報を保持します．
 *
 * @param licenseId 視聴可能ライセンスID [or BLANK]
 * @param licenseStart 視聴可能開始（DateArray） [or null]
 * @param licenseEnd 視聴可能終了（DateArray） [or null]
 * @param programUrl 再生制御情報URL [or BLANK]
 */
function ActiveLicense(licenseId, licenseStart, licenseEnd, programUrl) {
  this.licenseId = licenseId;
  this.licenseStart = licenseStart;
  this.licenseEnd = licenseEnd;
  this.programUrl = programUrl;
}

/**
 * ジャンル情報を保持します．
 *
 * @param title 表示文字列 [or BLANK]
 * @param genre ジャンルID [or BLANK]
 * @param child サブジャンルを示すID，存在しない場合はnull
 * @param sort ソートキー [or BLANK]
 */
function GenreInformation(title, genre, child, sort) {
  this.title = title;
  this.genre = genre;
  this.child = child;
  this.sort = sort;
}

/**
 * 検索結果が全結果の1部分の場合の情報を格納します．
 * totalCountが0の場合，contentListは長さ0の配列です．
 *
 * @param totalCount 全検索結果の件数
 * @param contentList contentInformationの配列
 */
function PageInformation(totalCount, contentList) {
  this.totalCount = totalCount;
  this.contentList = contentList;
}

/**
 * コンテンツ紹介画面の紹介文を保持します．
 * totalSizeが0の場合，synopsisは長さ0の文字列です．
 * totalCountは紹介文の表示に使うPage数とは違います．
 *
 * @param totalCount 全ページ数
 * @param synopsis synopsisの一部分
 */
function LongSynopsis(totalCount, synopsis) {
  this.totalCount = totalCount;
  this.synopsis = synopsis;
}

/**
 * TVサービス情報を保持します．
 *
 * @param serviceId サービスID
 * @param hasPurchase 購入コンテンツの場合1，それ以外0
 * @param licenseId チャンネルのライセンスID
 * @param tierbit チャンネルのティアビット
 */
function BroadCastEvent(serviceId, hasPurchase, licenseId, tierbit) {
  this.serviceId = serviceId;
  this.hasPurchase = hasPurchase;
  this.licenseId = licenseId;
  this.tierbit = tierbit;
}

// 通信AGT系

/**
 * ログイン結果[6-1]を保持します．
 *
 * @param nextcom 結果．成功 activelist_complete 失敗 それ以外
 */
function ResultLogin(nextcom) {
  this.nextcom = nextcom;
}

/**
 * 初期ログイン結果[1-7 6-1]および[6-1]を保持します．
 *
 * @param nextcom 結果．成功 startup_complete 失敗 initialize
 * @param mode 端末拡張設定文字列 [or BLANK]
 * @param ispid ISPID [or BLANK]
 * @param plan_code プランコード
 * @param plan_name プラン表示名
 * @param linetype 回線種別
 * @param drmid initialize時のsubscribe移項チェック用drmid
 * @param key initialize時のsubscribe移項チェック用key
 * @param volume_flag 操作音設定 ON:1 OFF:0
 */
function ResultLoginStartup(nextcom, mode, ispid, plan_code,
		plan_name, linetype, drmid, key, volume_flag) {
  this.nextcom = nextcom;
  this.mode = mode;
  this.ispid = ispid;
  this.plan_code = plan_code;
  this.plan_name = plan_name;
  this.linetype = linetype;
  this.drmid = drmid;
  this.key = key;
  this.volume_flag = volume_flag;
}

/**
 * [deleted 4/26] 
 * 基本契約登録結果(1-3呼び出し結果)およびエントリーコード入力結果[1-4]
 * を保持します．
 *
 * 注意点：
 * linetypeは1-3の呼び出し結果（checkContract）のみ設定されます．
 *
 * @param nextcom 結果．エントリコード入力要求 entry
 *                回線ID入力 customerid [or BLANK]
 * @param linetype 回線種別
 * function ResultContract(nextcom, linetype) {
 * this.nextcom = nextcom;
 * this.linetype = linetype;
 * }
 */

/**
 * [modified 4/26] 
 * checkContract, registEntryCode, resultCustomerId のレスポンスを保持します．
 *
 * @param nextcom そのままstartupへ：entry_complete，エントリコード入力へ：entry，
 * 回線ID入力へ：customerid，失敗：それ以外 [or BLANK]
 * @param ispid ISPID [or BLANK]（entry_completeの場合のみセット）
 * @param key KEY [or BLANK]（entry_completeの場合のみセット）
 * @param entry_code1 エントリコード1 [or BLANK]（entry_completeの場合のみセット）
 * @param entry_code2 エントリコード2 [or BLANK]（entry_completeの場合のみセット）
 * @param nttcustomerid 回線ID [or BLANK]（entry_completeの場合のみセット）
 * @param signarure シグネチャ [or BLANK]（entry_completeの場合のみセット）
 * @param certificats_url 公開鍵証明書URL [or BLANK]（entry_completeの場合のみセット）
 * @param drm_server_url DRMサーバURL [or BLANK]（entry_completeの場合のみセット）
 * @param mcLicenses MCライセンスID配列 [or null]（entry_completeの場合のみセット）
 * @param linetype 回線種別 [or null] (checkContractの結果がentry or customeridの場合
 * のみセット)
 */
function ResultSubscribe(nextcom, ispid, key, entry_code1, entry_code2,
                          nttcustomerid, signature, certificates_url,
                          drm_server_url, mcLicenses, linetype) {
  this.nextcom = nextcom;
  this.ispid = ispid;
  this.key = key;
  this.entry_code1 = entry_code1;
  this.entry_code2 = entry_code2;
  this.nttcustomerid = nttcustomerid;
  this.signature = signature;
  this.certificates_url = certificates_url;
  this.drm_server_url = drm_server_url;
  this.mcLicenses = mcLicenses;
  this.linetype = linetype;
}

/**
 * 契約情報を保持します．
 *
 * @param nextcom 結果．成功 active_list_complete，失敗 それ以外
 * @param plan_code プランコード
 * @param plan_name プラン名
 * @param basic_contract_id 基本契約ID
 * @param isp_userid お客様番号
 */
function ResultContractInformation(nextcom, plan_code, plan_name, basic_contract_id, isp_userid) {
  this.nextcom = nextcom;
  this.plan_code = plan_code;
  this.plan_name = plan_name;
  this.basic_contract_id = basic_contract_id;
  this.isp_userid = isp_userid;
}

/**
 * VODの購入状態を格納します．
 *
 * @param nextcom 結果．購入済み buy_complete ，未購入 buy_license
 * @param licenseId ライセンスID [or BLANK]
 * @param program_uri 再生制御情報URL [or BLANK]
 */
function ResultActiveLicense(nextcom, licenseId, program_uri) {
  this.nextcom = nextcom;
  this.licenseId = licenseId;
  this.program_uri = program_uri;
}

/**
 * ブックマーク登録・削除結果を格納します．
 *
 * @param nextcom 正常：mark_del_complete | mark_delall_complete 
 *| mark_add_complete 異常：それ以外
 */
function ResultBookmark(nextcom) {
  this.nextcom = nextcom;
}

/**
 * [modify 12/2 オブジェクト拡張 mcLicenses]
 * プラン変更確認処理，プラン変更処理の結果を格納します．
 *
 * @param nextcom プラン変更要：plan_change_act，プラン変更完了：plan_change_complete
 * @param nowPlanCode 現在のプランコード（プラン変更確認時のみ返却）[or BLANK]
 * @param nowPlanName 現在のプラン名（プラン変更確認時のみ返却）[or BLANK]
 * @param nowPriceWithTax 現在のプラン価格（プラン変更確認時のみ返却）[or BLANK]
 * @param nextPlanCode 変更先のプランコード
 * @param nextPlanName 変更先のプラン名
 * @param nextPriceWithTax 変更先のプラン価格
 * @param megstr プラン変更の注意文（プラン変更確認時のみ返却）[or BLANK]
 * @param contractDate プラン変更日時（プラン変更完了時のみ返却）[or null]
 * @param mcLicenses 単品チャンネル、チャンネルパック、チャンネルSVODの場合のみ
 *                  MCライセンスID配列  or null
 */
function ResultPlanChange(nextcom, nowPlanCode, nowPlanName, nowPriceWithTax, 
				nextPlanCode, nextPlanName, nextPriceWithTax, megstr, contractDate, mcLicenses) {
  this.nextcom = nextcom;
  this.nowPlanCode = nowPlanCode;
  this.nowPlanName = nowPlanName;
  this.nowPriceWithTax = nowPriceWithTax;
  this.nextPlanCode = nextPlanCode;
  this.nextPlanName = nextPlanName;
  this.nextPriceWithTax = nextPriceWithTax;
  this.megstr = megstr;
  this.contractDate = contractDate;
  this.mcLicenses = mcLicenses;
}

//////////////////////////      定数定義      /////////////////////////////////
/**
 * BML文書の基底URL．末尾のスラッシュを含まない。
 * ホスト名以降はgetActiveDocumentで取得して連結します。
 */
var BASE_URI="http://localhost"; // 試験環境用

/**
 * 初期登録，起動時に参照するURL．末尾のスラッシュを含まない。
 * ホスト名以降はgetActiveDocumentで取得して連結します。
 */
var BOOT_URI="http://localhost"; // 試験環境用

/**
 * CDN毎のBMLへのパス
 * ※CDN毎に設定されます。
 * BASE_URIはBMLが使います．BML_ROOTは整理用＋カスタマイズ向けで使用します。
 */
var BML_ROOT = BASE_URI + browser.getActiveDocument().split("/bml/")[0];

/**
 * 電源ONシーケンス開始URL
 */
var STARTUP_URI = BOOT_URI + browser.getActiveDocument().split("/bml/")[0] + "/startup.txt";

/**
 * ポータルアクセス要求開始URL
 */
var SUBSCRIBE_URI = BOOT_URI + browser.getActiveDocument().split("/bml/")[0]  + "/subscribe.txt";

/**
 * linetypeごとの回線コード接頭辞
 */
var LINETYPE_PREFIX=new Array();
LINETYPE_PREFIX['fdn-e']='COP';
LINETYPE_PREFIX['fdn-w']='S';
LINETYPE_PREFIX['ngn-e']='CAF';
LINETYPE_PREFIX['ngn-w']='CAF';

/**
 * 基本登録のexpire_date
 */
var EXPIRE_DATE=new Date(2028,3,1,0,0,0);

/**
 * エラーコード：再ログイン要求
 * 全ての通信で発生しうるコードです．本エラーコード取得時は再ログインを実行
 * してください．
 */
var ERROR_REQUEST_LOGIN="A20010454";

/**
 * ソートキー：
 */
// タイトル昇順
var SORT_TITLE_ASC                = 'sort_title_asc';
// タイトル降順
var SORT_TITLE_DESC               = 'sort_title_desc';
// 視聴終了日時昇順
var SORT_AVAILABILITY_END_ASC     = 'sort_availability_end_asc';
// 視聴終了日時降順
var SORT_AVAILABILITY_END_DESC    = 'sort_availability_end_desc';
// 新着開始日時昇順
var SORT_NEW_ARRIVAL_START_ASC    = 'sort_new_arrival_start_asc';
// 新着開始日時降順
var SORT_NEW_ARRIVAL_START_DESC   = 'sort_new_arrival_start_desc';
// INDEX昇順
var SORT_INDEX_ASC                = 'sort_index_asc';
// INDEX降順
var SORT_INDEX_DESC               = 'sort_index_desc';
// 出演者名昇順
var SORT_KEYWORD_NAME_ASC         = 'sort_keyword_name_asc';
// 出演者名降順
var SORT_KEYWORD_NAME_DESC        = 'sort_keyword_name_desc';
// ID昇順
var SORT_ID_CHAR_ASC              = 'sort_id_char_asc';
// ID降順
var SORT_ID_CHAR_DESC             = 'sort_id_char_desc';
// お知らせで使用
var SORT_DISPLAY_START_DESC             = 'sort_availability_start_desc';

/**
 * 検索IFへの要求電文パラメータ：ジャンル文字列
 */
var GENRE_HOME_TOP_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:0";
//var GENRE_HOME_TOP_NEW = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:0.1";
var GENRE_HOME_TOP_NEW = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:0.2";
var GENRE_VIDEO_TOP_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:2";
var GENRE_TV_TOP_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:1";
var GENRE_WIZARD_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:2.6";
var GENRE_TV_CH_LIST_NOT_IN = "urn:IPTVService:cs:NTT:ItemCategoryCS:2006:03:ch_without_epg";
var GENRE_ANNO_NEW = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:6.1.2";
var GENRE_ANNO_MAINT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:6.3.2";
var GENRE_ANNO_SUPP = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:6.2.2";
var GENRE_PREMIUM_TV = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:4.1";
var GENRE_PREMIUM_VIDEO = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:4.2";
var GENRE_PREMIUM_KARAOKE = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:4.3";
var GENRE_PREMIUM_OTHER = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:4.4";
var GENRE_KARAOKE_TOP_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:3";
var GENRE_KARAOKE_BY_ARTIST = "http://www.iptvf.jp/cs/2006/03/IPTVSERVICEItemCategoryCS:karaoke";
var GENRE_KARAOKE_BY_TITLE = "http://www.iptvf.jp/cs/2006/03/IPTVSERVICEItemCategoryCS:karaoke";
var GENRE_NOD_TOP_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:8";
var GENRE_NOD_REPEAT_WIZARD_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:8.1";
var GENRE_NOD_NEWS_WIZARD_GIT = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:8.2";
var GENRE_NOD_ANNO_ABOUT_NOD = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:8.8.1";
var GENRE_NOD_ANNO_FAQ = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:8.8.2";
var GENRE_NOD_ANNO_HELP = "urn:IPTVService:cs:NTT:NavigationCS:2006:03:8.8.3";

/**
 * 通信Agtの要求電文送信先
 */
var AGT_LOGIN_STARTUP = "startup";
var AGT_CHK_CONTRACT = "subscribe";
var AGT_REG_ENTRY = "certentrycode";
var AGT_REG_CUSTOM = "setcustomer";
var AGT_LOGIN = "login";
var AGT_CONTRACT_INFO = "contract";
var AGT_SEARCH = "search";
var AGT_BUY_TV_CONFIRM = "buy_license_tv_cfm";
var AGT_BUY_TV = "buy_license_tv";
var AGT_BUY_VOD_CONFIRM = "buy_license_vod_cfm";
var AGT_BUY_VOD = "buy_license_vod";
var AGT_BUY_KARAOKE_CONFIRM = "buy_license_karaoke_cfm";
var AGT_BUY_KARAOKE = "buy_license_karaoke";
var AGT_CANCEL_TV_CONFIRM = "cancel_license_tv_cfm";
var AGT_CANCEL_TV = "cancel_license_tv";
var AGT_CANCEL_VOD_CONFIRM = "cancel_license_video_cfm";
var AGT_CANCEL_VOD = "cancel_license_video";
var AGT_CANCEL_KARAOKE_CONFIRM = "cancel_license_karaoke_cfm";
var AGT_CANCEL_KARAOKE = "cancel_license_karaoke";
var AGT_LICENSE_LIST = "license_list";
var AGT_PLAN_LIST = "plan_list";
var AGT_ACTIVE_TV_LIST = "active_tv_list";
var AGT_ACTIVE_VOD_LIST = "active_vod_list";
var AGT_PURCHASE_LIST = "h_purchase_list";
var AGT_SET_PIN_CONFIRM = "set_pin_cfm";
var AGT_NEW_PIN = "new_pin";
var AGT_UPDATE_PIN = "upd_pin";
var AGT_UPDATE_CUSTOMER = "updatecustomer";
var AGT_RSV_KARAOKE_ADD = "rsv_karaoke_add";
var AGT_RSV_KARAOKE_DEL = "rsv_karaoke_del";
var AGT_RSV_KARAOKE_LIST = "rsv_karaoke_list";
var AGT_RSV_KARAOKE_NEXT = "rsv_karaoke_next";
var AGT_REGULATION_TEXT = "regulation_text";
var AGT_CONFIG_REG = "config_reg";
var AGT_INFO_DIALOG = "info_dialog";
var AGT_PLAN_CHANGE_CHECK = "plan_change_check";
var AGT_PLAN_CHANGE_ACT = "plan_change_act";
var AGT_MARK_ADD = "mark_add";
var AGT_MARK_DEL = "mark_del";
var AGT_MARK_GET = "mark_get";
var AGT_RESUME = "resume";
var AGT_SONG_LIST_KARAOKE = "song_list_karaoke";
var AGT_CHK_TRIAL_CONTRACT = "trial_subscribe";
var AGT_DRM_ID_CHECK = "drm_id_check";

/**
 * ライトプラン用プロモーション画像URI
 */
var TV_PROMOTION_URI="images/img_defalt01.png";

/**
 * BODY部resultコード：正常
 * 全ての通信で発生しうるコードです．サーバ側で正常に処理が行われた場合に返されます。
 */
var RESULT_CODE_NORMAL = "0";

/**
 * BODY部resultコード：準正常
 * 全ての通信で発生しうるコードです．サーバ側で準正常のエラーが発生した場合に返されます。
 */
var RESULT_CODE_WARNING = "2";

/**
 * BODY部resultコード：DRM_ID重複
 * 全ての通信で発生しうるコードです．サーバ側でDRM_ID重複のエラーが発生した場合に返されます。
 */
var RESULT_CODE_CONFLICTED_DRMID = "3";

/**
 * エラーコード：ユーザDB異常
 * 本エラーコード取得時はユーザDB異常として動作します．
 */
var ERROR_USER_DB = "A60030500";

/**
 * 設定ファイルのパス
 */
var SETTING_FILE_URI = BML_ROOT + "/bml/settings/bmlconfig.txt";

/**
 * genremenusディレクトリへのパス
 */
var GENREMENU_URI = BML_ROOT + "/bml/genremenus/";

/**
 * エラーメッセージ格納ディレクトリへのパス
 */
var ERRORMSG_URI = BML_ROOT + "/bml/errormsg/";

/**
 * epgTune()で指定するoriginal_network_id
 */
var ORG_NETWORK_ID = "7780";

/**
 * 要求電文中のrandom値を生成する際の最大値
 */
var RANDOM_RANGE = 5;

/**
 * ホームのお知らせ新着取得ランダム幅
 */
var HOME_NEWARRIVAL_RANDOM_RANGE = 10;

/**
 * extraObject格納データのキー名
 */
// NOD識別子
var EO_KEY_NOD = "EO_KEY_NOD";
// 規約URL
var EO_KEY_REGULATION_URL = "EO_KEY_REGULATION_URL";

// **********以降の定数は設定ファイルから取得**********

/**
 * 配信ステータスアイコンで 配信予定のX/Y- と 終了間近の-X/Y を計算する日数
 * ※設定ファイルから取得します．
 */
var DELIVERY_ICON_DAY_NUM = "";

/**
 * サービス未契約ページURL
 * ※設定ファイルから取得します．
 */
var PROMOTION_URI = "";

/**
 * パレンタルレートのマップ
 * ※設定ファイルから取得します．
 */
var PARENTAL_MAP = new Array();

/**
 * 通信エージェントへのPATH
 * ※設定ファイルから取得します．
 */
var AGENT_URI = "";

/**
 * BML向け検索IFへのPATH
 * ※設定ファイルから取得します．
 */
var META_SEARCH_URI = "";

/**
 * サービス事業者ID(ip_service_provider_id)
 * ※設定ファイルから取得します．
 */
var IP_SERVICE_PROVIDER_ID="01";

/**
 * 配信ステータスアイコンで 配信予定のX/Y- と 終了間近の-X/Y を計算する日数
 * ※設定ファイルから取得します．
 */
var DELIVERY_ICON_DAY_NUM=10;

/**
 * linetypeごとの回線コード接頭辞
 */
var LINETYPE_PREFIX=new Array();
LINETYPE_PREFIX['fdn-e']='COP';
LINETYPE_PREFIX['fdn-w']='S';
LINETYPE_PREFIX['ngn-e']='CAF';
LINETYPE_PREFIX['ngn-w']='CAF';

/**
 * CRIDの接頭辞
 * ※設定ファイルから取得します．
 */
var CRID_PREFIX = "";

/**
 * デモ端末を示すISPID
 * コンテンツ紹介画面でdemoNGのコンテンツの場合、「デモ不可」ボタンを表示する際に使用します。
 * ※設定ファイルから取得します．
 */
var ISPID_DEMO = "";

/**
 * 基本登録削除用署名
 * ※設定ファイルから取得します．
 */
var REMOVE_SIGNATURE = "";

/**
 * 基本登録削除用証明書URL
 * ※設定ファイルから取得します．
 */
var REMOVE_CERTIFICATES_URL = "";

/**
 * 基本登録削除用DRMサーバURL
 * ※設定ファイルから取得します．
 */
var REMOVE_DRM_SERVER_URL = "";

/**
 * プランコード生成用CRIDの接頭辞
 * ※設定ファイルから取得します．
 */
var PLAN_CRID_PREFIX = "";

/**
 * お試し端末を示すISPID
 * ※設定ファイルから取得します．
 */
var ISPID_TRIAL = "";

/**
 * お試しホームVODプログラムURL
 * ※設定ファイルから取得します．
 */
var TRIAL_HOME_PROGRAM_URL = "";

/**
 * 基本登録のexpire_date
 */
var EXPIRE_DATE=new Date(2028,3,1,0,0,0);

/**
 * サービス未契約ページURL
 * ※設定ファイルから取得します．
 */
var PROMOTION_URI="info.bml";

/**
 * BML文書の基底URL．末尾のスラッシュを含まない。
 * ※本ファイルは回線タイプ毎に4つ生成しBASE_URIはそれぞれ別々の値を返却します．
 * ホスト以降はgetActiveDocumentで取得して連結します。
 */
var BASE_URI="http://localhost";

/**
 * エラーコード：再ログイン要求
 * 全ての通信で発生しうるコードです．本エラーコード取得時は再ログインを実行
 * してください．
 */
var ERROR_REQUEST_LOGIN="A454";

/**
 * DEMO端末を示すISPID
 * ※設定ファイルから取得します．
 */
var ISPID_DEMO="005";

/**
 * epgTune()で指定するoriginal_network_id
 * ※設定ファイルから取得します．
 */
var ORG_NETWORK_ID="7780";

var PARENTAL_MAP = new Array();
var AGENT_URI="agent";
var META_SEARCH_URI="meta";
var CRID_PREFIX="crid://4th./";

/////////////////////APIで使用するグローバル変数定義///////////////////////////
/**
 * パレードGITのCRID
 */
var g_parade_content = null;

/**
 * エラー情報配列
 */
var g_errors = new Array();

/**
 * API内部エラーメッセージ定数(定数初期化エラー)
 */
var ERRORMSG_CONST = "";

/**
 * API内部エラーメッセージ定数(応答電文エラー)
 */
var ERRORMSG_TSV = "";

/**
 * API内部エラーメッセージ定数(引数エラー等)
 */
var ERRORMSG_PARAM = "";

/**
 * API内部エラーメッセージ定数(通信エラー)
 */
var ERRORMSG_HTTP = "";

/**
 * API内部エラーメッセージ定数(対向サーバエラー)
 * ※対向サーバエラーメッセージがない場合のみ設定する
 */
var ERRORMSG_SERVER = "";

/**
 * エラーコード：ユーザDB異常
 * 
 * 本エラーコード取得時はユーザDB異常として動作
 * してください．
 */
var ERROR_USER_DB="A60030500";



//////////////////////////      関数定義      /////////////////////////////////
/**
 * 定数を設定ファイルから初期化します．
 * BML初期化の際に1度のみ呼び出してください．
 * 将来的にBML単位，ispid単位，pageid単位で別々の設定ファイルをロードする
 * 可能性があるため，引数に上記値を指定します．現状は全BML共通で1つの設定
 * ファイルです．
 * @param linetype 回線タイプ
 * @param ispid ISPID
 * @param pageid ページID
 * @return 生成結果，OK or NG
 * 注意点：
 * ・エラー時はエラー情報を設定します．
 */
function initParams(linetype, ispid, pageid) {
	var apiId = "001";

	g_errors = new Array();
	// 生成結果
	var result = "NG";
	
	// 設定ファイル要求
	var ret = browser.transmitTextDataOverIP(SETTING_FILE_URI, null, "EUC-JP");
	
	// 応答電文のエラーチェック処理
	var constList = checkResponse(ret, 0, apiId, "");
	if (constList == null) {
		return null;
	}
	// 設定ファイルパース処理
	var parentalMap = new Array();
	var obj = new Object();
	for (var i = 0; i < constList.length; i++) {
		var constLine = constList[i];
		if (constLine.length == 0 || constLine.indexOf("#") == 0) {
			continue;
		}
		var constant = splitEx(constLine, "=");
		
		if (constant[0] == "PARENTAL_MAP") {
			// パレンタルマッピングの場合
			var par = constant[1].split(":");
			parentalMap[par[0]] = (par[1]);
		} else {
			// パレンタルマッピング以外の場合
			obj[constant[0]] = constant[1];
		}
	}
	// 定数に格納
	DELIVERY_ICON_DAY_NUM = obj["DELIVERY_ICON_DAY_NUM"];
	PROMOTION_URI = obj["PROMOTION_URI"];
	PARENTAL_MAP = parentalMap;
	AGENT_URI = obj["AGENT_URI"];
	META_SEARCH_URI = obj["META_SEARCH_URI"];
	IP_SERVICE_PROVIDER_ID = obj["IP_SERVICE_PROVIDER_ID"];
	CRID_PREFIX = obj["CRID_PREFIX"];
	ISPID_DEMO = obj["ISPID_DEMO"];
	REMOVE_SIGNATURE = obj["REMOVE_SIGNATURE"];
	REMOVE_CERTIFICATES_URL = obj["REMOVE_CERTIFICATES_URL"];
	REMOVE_DRM_SERVER_URL = obj["REMOVE_DRM_SERVER_URL"];
	PLAN_CRID_PREFIX = obj["PLAN_CRID_PREFIX"];
	ISPID_TRIAL = obj["ISPID_TRIAL"];
	TRIAL_HOME_PROGRAM_URL = obj["TRIAL_HOME_PROGRAM_URL"];
	
	// エラーチェック
	if (DELIVERY_ICON_DAY_NUM == null || DELIVERY_ICON_DAY_NUM.length == 0) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (PROMOTION_URI == null || PROMOTION_URI.length == 0) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (PARENTAL_MAP == null || PARENTAL_MAP.length == 0) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (AGENT_URI == null || AGENT_URI.length == 0) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (META_SEARCH_URI == null || META_SEARCH_URI.length == 0) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (IP_SERVICE_PROVIDER_ID == null || IP_SERVICE_PROVIDER_ID.length == 0) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (CRID_PREFIX == null) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (ISPID_DEMO == null || ISPID_DEMO.length == 0) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (REMOVE_SIGNATURE == null) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (REMOVE_CERTIFICATES_URL == null) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (REMOVE_DRM_SERVER_URL == null) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (PLAN_CRID_PREFIX == null) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (ISPID_TRIAL == null || ISPID_TRIAL.length == 0) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	} else if (TRIAL_HOME_PROGRAM_URL == null) {
		addError(new Error(apiId, "00", "000000000", ERRORMSG_CONST));
		return result;
	}
	return "OK";
}

/**
 * DRMIDが不正DRMIDかどうかチェックします．
 * 初期登録画面、サービス案内画面の初期表示時に呼び出されます．
 *
 * 注意点：
 * ・判定結果がNGの場合，エラー情報が追加されます．
 * 
 * @param drmid 端末のDRMID
 * @param key KEY
 * @return 正常DRMID：OK 不正DRMID：NG
 */
function drmidCheck(drmid, key) {
	var apiId = "107";
	return "OK";
}

/**
 * ホームのパレードリストを取得します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 内部処理フロー
 * ・g_parade_cridが設定されていない場合，サーバよりCRIDを取得．
 * ・引数の検索オプションを指定してg_parade_cridに含まれるPITリストを取得．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・サーバから返却されるg_parade_cridの値は仕様上ランダムなため，BMLを跨いだ
 *   パレードリストの利用にはg_parade_cridの引渡しが必要になります．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function getHomeParade(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "homeParade.tsv",
						 page, 5 ,PARADE_NUM_PER_PAGE, HOME_PARADE_TOTAL);
}

/**
 * VODトップのパレードリストを取得します．
 *
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 内部処理フロー
 * ・g_parade_cridが設定されていない場合，サーバよりCRIDを取得．
 * ・引数の検索オプションを指定してg_parade_cridに含まれるPITリストを取得．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・サーバから返却されるg_parade_cridの値は仕様上ランダムなため，BMLを跨いだ
 *   パレードリストの利用にはg_parade_cridの引渡しが必要になります．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function getVODParade(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "vodParade.tsv",
						 page, 5 ,PARADE_NUM_PER_PAGE, VOD_PARADE_TOTAL);
}

/**
 * ジャンル検索のジャンル情報配列を取得します．
 * メインジャンルのリストをとる場合はchildに"ROOT"を指定してください．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param child 子ジャンルの識別子
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 */
function getGenresForGenre(child, ispid, mode, age) {
	var filename = "";
	if (child == "ROOT") {
		filename = "mainGenre.tsv";
	} else {
		filename = "subGenre_" + child + ".tsv";
	}
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * ランキング検索のジャンル情報配列を取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 */
function getGenresForRanking(ispid, mode, age) {
	var filename = "mainGenre_ranking.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * 終了間近検索のジャンル情報配列を取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param  検索時の最低視聴年齢．
 * @return GenreInformationの配列
 */
function getGenresForComingEnd(ispid, mode, age) {
	var filename = "mainGenre_comingend.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * 新着検索のジャンル情報配列を取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 */
function getGenresForNewArrival(ispid, mode, age) {
	var filename = "mainGenre_newarrival.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * ジャンルを指定してランキング検索を実行します．
 * ContentInformationにはcrid, type, Period, sortのみ格納されます．
 *
 * 本検索は他のVOD検索と違い，ジャンルごとにランキングGITが配置される構造の
 * のため，内部で下記2回の通信を行います．
 *
 * ・ジャンルを指定して，ランキングGITContentInformationを取得する．
 * ・ランキングGITCRID，ページ指定，各検索条件を付与しserchVODMemberOfを呼び出し
 *   コンテンツリストを取得する．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param genre ジャンル文字列
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchRanking(genre, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchRanking.tsv",
						 page, 9 ,VOD_LIST_NUM_PER_PAGE, VOD_CONTENT_TOTAL);
}

/**
 * ジャンル検索を実行します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period,Icon, sortのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param genre ジャンル文字列
 * @param sort ソートキー
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchGenre(genre, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchGenre.tsv",
						 page, 9 ,VOD_LIST_NUM_PER_PAGE, VOD_CONTENT_TOTAL);
}

/**
 * ジャンルを指定して新着検索を実行します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period,Icon, sortのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param genre ジャンル文字列
 * @param sort ソートキー
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchNewArrival(genre, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchNewArrival.tsv",
						 page, 9 ,VOD_LIST_NUM_PER_PAGE, VOD_CONTENT_TOTAL);
}

/**
 * ジャンルを指定して終了間近検索を実行します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period,Icon, sortのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param genre ジャンル文字列
 * @param sort ソートキー
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchComingEnd(genre, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchComingEnd.tsv",
						 page, 9 ,VOD_LIST_NUM_PER_PAGE, VOD_CONTENT_TOTAL);
}

/**
 * 4桁のIDを指定してID検索を実行します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period,Icon, sortのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param id ID(4桁)
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchIdList(id, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchId.tsv",
						 page, 9 ,VOD_LIST_NUM_PER_PAGE, VOD_IDLIST_TOTAL);
}

/**
 * 5桁のIDを指定してID検索を実行します．
 * 戻り値のPageInformationに含まれるContentInformationは必ず１つで，全ての情報
 * が格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param id ID(5桁)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchIdDetail(id, ispid, mode, age) {
	// idの剰余をtsvの取得行数とする
	var index = id % VOD_IDLIST_TOTAL;

	var result = new PageInformation(1, new Array(getOneContent(STUB_PATH + "getVODContentDetail.tsv", index)));
	result.contentList[0].contentDetail.packPurchaseLicense
		= getPL(STUB_PATH +"vodPurchaseLicense.tsv");
	return result;
}

/**
 * CRIDを指定してVODの関連コンテンツ検索を実行します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period,Icon, sortのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param crid 関連元ののCRID
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchVODRelatedContents(crid, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchVODRelatedContents.tsv",
						 page, 9 ,VOD_LIST_NUM_PER_PAGE, VOD_RELATED_CONTENT_TOTAL);
}

/**
 * CRIDを指定してVODパックに含まれるコンテンツ検索を実行します．通常パック検索，
 * シリーズ検索，ウィザード検索で使用します．
 *
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, Icon, sortのみ格納されます．
 * 有効なdisplayTypeは以下です。
 *
 * video_package           // パック
 * video_series            // シリーズ
 * wizard                  // ウィザード型
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはパックのContentInfoのsortを指定して下さい．
 *
 * @param crid GITのCRID
 * @param displayType GITのdisplayType
 * @param sort
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchVODMemberOf(crid, displayType, sort, page, ispid, mode, age) {
	if (displayType == "wizard") {
		return getMaxLines(STUB_PATH + "searchWizardMemberOf.tsv",
							 page, 9 ,VOD_LIST_NUM_PER_PAGE,
							 MEMBER_OF_WIZARD_TOTAL);
    } else {
		return getMaxLines(STUB_PATH + "searchVODMemberOf.tsv",
							 page, 9 ,VOD_LIST_NUM_PER_PAGE, MEMBER_OF_VOD_TOTAL);
	}
}

/**
 * トップのメニューから遷移するウィザードGITを取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * 戻り値のPageInformation内のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getWizardGIT(ispid, mode, age) {
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "getWizardGIT.tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var contentList = ret[2].split("\r\n");

	return new PageInformation(1, new Array(tsvParseForCIList(contentList[0])));
}

/**
 * [10/20 modify] BD/isAdultパース処理追加
 *                BD/rValueパース処理追加
 *                AL/cid,stoppositionパース処理追加
 *                Icon/deliveryパース処理追加
 * 
 * CRIDを指定してコンテンツ詳細情報を取得します．
 * VOD、VODパックの詳細で利用します．
 *
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * 戻り値のContentInformationには全ての情報が格納されます．
 *
 * 有効なdisplayTypeは以下です。
 * video_program           // 作品紹介
 * video_package           // パック
 * video_series            // シリーズ
 * wizard                  // ウィザード型
 *
 * @param crid CRID
 * @param displayType
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getVODContentDetail(crid, displayType, ispid, mode, age) {
	// CRIDの末尾の数字をtsvの取得行数とする
	var token = crid.split("_");
	var result =  getOneContent(STUB_PATH + "getVODContentDetail.tsv",
								token[token.length - 1]);
	result.contentDetail.packPurchaseLicense
		= getPL(STUB_PATH +"vodPurchaseLicense.tsv");
	return result;
}

/**
 * CRIDを指定してVODコンテンツの詳細Synopsisを取得します．
 * 戻り値のLongSynopsisにはサーバで設定されたバイト数分のSynopsisが格納されます．
 *
 * 有効なdisplayTypeは以下です。
 *
 * video_program           // 作品紹介
 *
 * 注意点：
 * ・本関数のpageは画面表示上のページと連動していません．
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param crid CRID
 * @param displayType
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return シノプシス情報．
 */
function getVODSynopsis(crid, displayType, page, ispid, mode, age) {
	if (displayType != "video_program") {
		return null;
	}
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH +
                                   "vodSynopsis.tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForLongSynopsis(tsvList[i]);
	}

	return result[page];
}

/**
 * ログインを行います．通常は通信エージェントからの再ログイン要求受信の
 * 際に使用します。
 *
 * 注意点：
 * ・エラー時は，エラー情報を登録しnullが返却される場合と，resultに結果が格納
 *   されることがあります．
 *
 * @param drmid
 * @param key
 * @return ログイン結果（nextcomがactivelist_completeかそれ以外）
 */
function login(drmid, key) {

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "login.tsv", null, "EUC-JP");

	// パースしつつオブジェクトを生成
	return tsvParseForResLogin(ret[2]);
}

/**
 * startup.bml初期化時の初期ログイン[1-7 6-1]を実行します。
 *
 * @param drmid
 * @param key
 * @return ログイン結果（nextcomがstartup_completeかinitializeかinitialize_all）
 */
function loginStartup(drmid, key) {
	var apiId = "002";
	
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "loginStartup.tsv", null, "EUC-JP");

	// パースしつつオブジェクトを生成
	return tsvParseForResLoginStartup(ret[2]);
}

/**
 * [modified 4/26] 
 * 基本契約登録確認[1-3]を行います．
 *
 * 注意点：
 * ・エラー時は，エラー情報を登録しnullが返却される場合と，nextcomに結果が格納
 *   されることがあります．
 *
 * @param drmid
 * @param key
 */
function checkContract(drmid, key) {

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "checkContract.tsv", null, "EUC-JP");

	// パースしつつオブジェクトを生成
	//return tsvParseForResCnt(ret[2]);
	//return new ResultSubscribe("entry", "", "", "", "", "", "", "", "", null, "fdn-e");
	return tsvParseForResultSubscribe(ret[2]);
}

/**
 * [modified 4/26] 
 * エントリコード登録[1-4]を行います．
 *
 * 注意点：
 * ・エラー時は，エラー情報を登録しnullが返却される場合と，nextcomに結果が格納
 *   されることがあります．
 * ・本関数呼び出し結果により以下の処理分岐が必要です．
 *   -nextcomがentry…エントリコード再入力
 *   -nextcomがcustomerId…回線ID入力
 *   -nextcomが上記以外…エラーとしてinfo.bmlへ遷移
 *   -戻り値がnullでerrorセット…エラーメッセージを表示して遷移不能状態
 */
function registEntryCode(entrycode, drmid, key) {
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "registEntryCode.tsv", null, "EUC-JP");

	// パースしつつオブジェクトを生成
	//return tsvParseForResCnt(ret[2]);
	//return new ResultSubscribe("customerid", "", "", "", "", "", "", "", "", null, "");
	return tsvParseForResultSubscribe(ret[2]);
}

/**
 * [modified 4/26] 
 * 回線ID登録[1-5]を行います．
 * 初期登録と，回線ID設定画面で利用します．
 *
 * 注意点：
 * ・エラー時は，エラー情報を登録しnullが返却される場合と，nextcomに結果が格納
 *   されることがあります．
 * ・本関数呼び出し成功後，取得した情報から基本登録，MCライセンス取得を実行して
 *   下さい．
 */
function registCustomerId(customerid, drmid, key) {

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "registCustomerId.tsv", null, "EUC-JP");

	// パースしつつオブジェクトを生成
	//return tsvParseForResCustmID(ret[2]);
	//return new ResultSubscribe("entry_complete", "0004", "aaaabbbb", "09876543", "12345678", "65656567", "01234567890SsIiGgNnAaTtUuRe////", "http://certificates.url.com/aaa", "http://drm.server.url.com/bbb", 
	//new Array("11111111", "22222222", "33333333"), "");
	return tsvParseForResultSubscribe(ret[2]);
}

/**
 * 契約情報[6-2]を取得します．
 * マイページで利用します．
 *
 * 注意点：
 * ・エラー時は，エラー情報を登録しnullが返却される場合と，resultに結果が格納
 *   されることがあります．
 *
 */
function getContractInformation(drmid, key) {

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "getContractInformation.tsv", null, "EUC-JP");

	// パースしつつオブジェクトを生成
	return tsvParseForResCntInf(ret[2]);
}


/**
 * 基本契約登録確認[1-3]を行います．
 * [1-3]の結果がentry、customeridの場合は通信Agentが登録サーバへお試し登録を実施します．
 *
 * 注意点：
 * ・エラー時は，エラー情報を登録しnullが返却される場合と，nextcomに結果が格納
 *   されることがあります．
 *
 * @param drmid 端末のDRMID
 * @param key KEY
 * @return ResultSubscribe
 */
function checkTrialContract(drmid, key) {
	var apiId = "106";
	
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "checkContract.tsv", null, "EUC-JP");

	// パースしつつオブジェクトを生成
	//return tsvParseForResCnt(ret[2]);
	//return new ResultSubscribe("entry", "", "", "", "", "", "", "", "", null, "fdn-e");
	return tsvParseForResultSubscribe(ret[2]);
}

/**
 * [modify 5/9]
 * 設定画面の回線ID登録結果を格納します．
 *
 * 注意点：
 * ・エラー時は，エラー情報を登録しnullが返却される場合と，resultに結果が格納
 *   されることがあります．
 * 
 * @param nextcom 成功：mc_input_complete
 * @param mcStatus 0 | 1 | 2 | 3 BMLでは利用しません
 * @param linetype BMLでは利用しません
 * @param message 成功時の表示メッセージ
 * @param validStartDate 設定が反映される時間（DateArray） [or null] 
 * BMLでは利用しません
 */
function ResultMcInput(nextcom, mcStatus, linetype, message, validStartDate) {
  this.nextcom = nextcom;
  this.mcStatus = mcStatus;
  this.linetype = linetype;
  this.message = message;
  this.validStartDate = validStartDate;
}

/**
 * 設定画面の回線ID登録[7-2]を実施します．
 *
 * 注意点：
 * ・エラー時は，エラー情報を登録しnullが返却される場合と，resultに結果が格納
 *   されることがあります．
 *
 * @param customerid 回線ID
 * @param drmid DRMID
 * @param key KEY
 * @return 回線ID登録結果
 */
function mcInput(customerid, drmid, key) {
  // return new ResultMcInput("mc_input_complete", 1 , "fdn-e", "2008年5月9日 15:00から有効になりますので，しばらくお待ち下さい．", new Array(2008, 4, 9, 15, 0, 0));

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "mcInput.tsv", null, "EUC-JP");

	// パースしつつオブジェクトを生成
	var t = ret[2].split("\t");
	var i = 0;
	return new ResultMcInput(t[i++],t[i++],t[i++],t[i++],stringToDateArray(t[i++]));
}

/**
 * VODコンテンツの購入状態[2-4]を取得します．
 * コンテンツ紹介画面で「購入」ボタン押下時に呼び出し，戻り値が「購入済み」
 * であればそのままlaunchIPTVContentによりVODの再生を行います．
 *
 * @param crid コンテンツCRID
 * @param drmid
 * @param key
 */
function checkActiveLicense(crid, drmid, key) {
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH +
                           "checkActiveLicense.tsv", null, "EUC-JP");

	// パースしつつオブジェクトを生成
	return tsvParseForResActLic(ret[2]);
}

/**
 * TVトップのパレードリストを取得します．
 *
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 内部処理フロー
 * ・g_parade_cridが設定されていない場合，サーバよりCRIDを取得．
 * ・引数の検索オプションを指定してg_parade_cridに含まれるPITリストを取得．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・サーバから返却されるg_parade_cridの値は仕様上ランダムなため，BMLを跨いだ
 *   パレードリストの利用にはg_parade_cridの引渡しが必要になります．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function getTVParade(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "tvParade.tsv",
						 page, 5 ,PARADE_NUM_PER_PAGE, TV_PARADE_TOTAL);
}

/**
 * CRIDを指定してパックに含まれるコンテンツ検索を実行します．番組シリーズ詳細
 * 画面で使用します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, Icon, sort，broadCastEventのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはパックのContentInfoのsortを指定して下さい．
 *
 * @param crid GITのCRID
 * @param sort
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchTVSeriesMemberOf(crid, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchTVSeriesMemberOf.tsv",
							 page, 5 ,TV_SERIES_LIST_NUM_PER_PAGE,
							 TV_SERIES_TOTAL);
}

/**
 * [10/20 modify] Icon/deliveryパース処理追加
 * 
 * CRIDを指定してTVコンテンツの詳細情報を取得します．
 * TVチャンネルの詳細で利用します．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * 戻り値のContentInformationには全ての情報が格納されます．
 *
 * 有効なdisplayTypeは以下です。
 *
 * tv_channel              // チャンネル紹介型
 * tv_programs_promotion   // 番組シリーズ詳細型
 *
 * @param crid CRID
 * @param displayType
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getTVContentDetail(crid, displayType, ispid, mode, age) {
	var token = crid.split("_");
	var result =  getOneContent(STUB_PATH + "getTVContentDetail.tsv",
								token[token.length - 1]);
	result.contentDetail.packPurchaseLicense
		= getPL(STUB_PATH + "tvPurchaseLicense.tsv");
	return result;
}

/**
 * serviceIdを指定してTVチャンネル詳細を取得します．番組シリーズ詳細
 * 画面からチャンネル紹介に遷移する際使用します．
 * 戻り値のContentInformationには全ての情報が格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param serviceId チャンネルのserviceId
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getChannelDetail(serviceId, ispid, mode, age) {
        var index = 0;
        if (serviceId < 400) {
            index = serviceId - 282;
        } else if (serviceId < 500) {
            index = serviceId - 394;
        } else if (serviceId < 600) {
            index = serviceId - 490;
        } else {
            index = serviceId - 582;
        }
	var result =  getOneContent(STUB_PATH + "getTVContentDetail.tsv",
								index);
	result.contentDetail.packPurchaseLicense
		= getPL(STUB_PATH + "tvPurchaseLicense.tsv");
	return result;
}

/**
 * CRIDを指定してTVコンテンツの詳細Synopsisを取得します．
 * 戻り値のLongSynopsisにはサーバで設定されたバイト数分のSynopsisが格納されます．
 *
 * 有効なdisplayTypeは以下です。
 * tv_channel              // チャンネル紹介型
 * tv_programs_promotion   // 番組シリーズ詳細型
 *
 * 注意点：
 * ・本関数のpageは画面表示上のページと連動していません．
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param crid CRID
 * @param displayType
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return シノプシス情報
 */
function getTVSynopsis(crid, displayType, page, ispid, mode, age) {
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH +
                                   "tvSynopsis.tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForLongSynopsis(tsvList[i]);
	}

	return result[page];
}

/**
 * チャンネル一覧のジャンル情報配列を取得します．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 */
function getGenresForTV(ispid, mode, age) {
	var filename = "mainGenre_tv.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * TVチャンネルのジャンル検索を実行します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period,Icon, sort，BroadCastEventのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param genre ジャンル文字列
 * @param sort ソートキー
 * @param page 取得するページ番号（1開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchTVGenre(genre, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchTVGenre.tsv",
						 page, 5 ,TV_CHANNEL_LIST_NUM_PER_PAGE,
						 CHANNEL_TOTAL);
}

/**
 * CRIDを指定してパックに含まれるコンテンツ検索を実行します．チャンネルパック
 * 紹介，チャンネルSVOD紹介，SVOD紹介で使用します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, Icon, sortのみ格納されます．
 * 有効なDisplayTypeは以下です。
 *
 * channel_package         // チャンネルパック型
 * subscription_package    // 見放題
 * series_svod             // 見放題
 * channel_svod            // チャンネルSVOD型
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはパックのContentInfoのsortを指定して下さい．
 *
 * @param crid GITのCRID
 * @param sort
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchCHSVODMemberOf(crid, displayType, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchCHSVODMemberOf.tsv",
						 page, 9 ,VOD_LIST_NUM_PER_PAGE, MEMBER_OF_CHSVOD_TOTAL);
}

/**
 * [10/20 modify] BD/isAdultパース処理追加
 *                BD/rValueパース処理追加
 *                Icon/deliveryパース処理追加
 *
 * CRIDを指定してコンテンツの詳細情報を取得します．
 * チャンネルパック紹介，チャンネルSVOD紹介，SVOD紹介で使用します．
 *
 * 有効なDisplayTypeは以下です。
 *
 * channel_package         // チャンネルパック型
 * subscription_package    // 見放題
 * series_svod             // 見放題
 * channel_svod            // チャンネルSVOD型
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * 戻り値のContentInformationには全ての情報が格納されます．
 *
 * @param crid CRID
 * @param displayType
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getCHSVODContentDetail(crid, displayType, ispid, mode, age) {
	var token = crid.split("_");
	return getOneContent(STUB_PATH + "getCHSVODContentDetail.tsv",
								token[token.length -1]);
}

/**
 * CRIDを指定してお知らせコンテンツ詳細情報を取得します．
 * お知らせ詳細で利用します．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * 戻り値のContentInformationには全ての情報が格納されます．
 *
 * 有効なdisplayTypeは以下です。
 * announcement           // お知らせ
 *
 * @param crid CRID
 * @param displayType
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getAnnouncementContentDetail(crid, displayType, ispid, mode, age) {
	// CRIDの末尾の数字をtsvの取得行数とする
	var token = crid.split("_");
	return getOneContent(STUB_PATH + "getAnnouncementContentDetail.tsv",
								token[token.length - 1]);
}

/**
 * ホームのお知らせ情報をランダムに1つ取得します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function getHomeAnnouncement(ispid, mode, age) {
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH +
			 "getHomeAnnouncement.tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var contentList = ret[2].split("\r\n");

	return new PageInformation(1, new Array(tsvParseForCIList(contentList[0])));
}

/**
 * お知らせ画面の新着情報リストを取得します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function getNewAnnouncements(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "getNewAnnouncements.tsv",
						 page, 9 ,ANNO_LIST_NUM_PER_PAGE, NEW_ANNO_TOTAL);
}

/**
 * お知らせ画面のメンテナンス情報リストを取得します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function getMaintenances(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "getMaintenances.tsv",
						 page, 9 ,ANNO_LIST_NUM_PER_PAGE, MAINTENANCES_TOTAL);
}

/**
 * お知らせ画面のサポート情報リストを取得します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function getSupports(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "getSupports.tsv",
						 page, 9 ,ANNO_LIST_NUM_PER_PAGE, SUPPORTS_TOTAL);
}

/**
 * CRIDを指定してパックに含まれるコンテンツ検索を実行します．お知らせ画面の
 * サポートのリストで使用します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, Icon, sortのみ格納されます．
 * 有効なDisplayTypeは以下です。
 *
 * video_series            // シリーズ
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはパックのContentInfoのsortを指定して下さい．
 *
 * @param crid GITのCRID
 * @param sort
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchAnnouncementMemberOf(crid, displayType, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "getSupports.tsv",
						 page, 9 ,ANNO_LIST_NUM_PER_PAGE, SUPPORTS_TOTAL);
}

/**
 * CRIDを指定してお知らせ画面の詳細Synopsisを取得します．
 * お知らせ詳細，メンテナンス詳細，サポート詳細で利用します．
 * 戻り値のLongSynopsisにはサーバで設定されたバイト数分のSynopsisが格納されます．
 * 注意点：
 * ・本関数のpageは画面表示上のページと連動していません．
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param crid CRID
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return シノプシス情報
 */
function getAnnouncementSynopsis(crid, page, ispid, mode, age) {
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH +
                                   "announcementSynopsis.tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForLongSynopsis(tsvList[i]);
	}

	return result[page];
}

/**
 * CRIDを指定してお知らせの関連コンテンツ検索を実行します．
 * ContentInformationにはcrid, type, BasicDescription,
 * Period,Icon, sortのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param crid 関連先のCRID
 * @param page 取得するページ番号
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchAnnouncementRelatedContent(crid, ispid, mode, age) {
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH
				+ "searchAnnouncementRelatedContent.tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var contentList = ret[2].split("\r\n");

	// レコード毎にパースしつつオブジェクトを生成
	return tsvParseForCI(contentList[0]);
}

/**
 * プレミアムのジャンル情報配列を取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param  検索時の最低視聴年齢．
 * @return GenreInformationの配列
 */
function getGenresForPremium(ispid, mode, age) {
	var filename = "mainGenre_premium.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * [modify 9/8 ジャンルID：4.4（その他（ガイド誌））の場合の条件を追加しました]
 *
 * ジャンルを指定してプレミアム検索を実行します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period,Icon, sortのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param genre ジャンル文字列
 * @param sort ソートキー
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchPremium(genre, sort, page, ispid, mode, age) {
	var id = genre.split('.');
	var total = 0;
	if (id[id.length -1] == 1) {
	    total = PREMIUM_1_TOTAL;
	} else if (id[id.length -1] == 2) {
	    total = PREMIUM_2_TOTAL;
	} else if (id[id.length -1] == 3) {
	    total = PREMIUM_3_TOTAL;
	}  else if (id[id.length -1] == 4) {
	    total = PREMIUM_4_TOTAL;
	} 
	return getMaxLines(STUB_PATH + "searchPremium_" + id[id.length - 1] + ".tsv",
						 page, 9 ,VOD_LIST_NUM_PER_PAGE, total);
}

/**
 * [10/20 modify] Icon/deliveryパース処理追加
 * 
 * CRIDを指定してカラオケライセンスの詳細情報を取得します．
 * カラオケライセンス紹介で使用します．
 *
 * 有効なDisplayTypeは以下です。
 *
 * karaoke_package         // カラオケパック型
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * 戻り値のContentInformationには全ての情報が格納されます．
 *
 * @param crid CRID
 * @param displayType
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getKaraokeLicenseDetail(crid, displayType, ispid, mode, age) {
	var token = crid.split("_");
	return getOneContent(STUB_PATH + "getCHSVODContentDetail.tsv",
								token[token.length - 1]);
}

/**
 * CRIDを指定してカラオケライセンスの詳細Synopsisを取得します．
 * 戻り値のLongSynopsisにはサーバで設定されたバイト数分のSynopsisが格納されます．
 *
 * 有効なdisplayTypeは以下です。
 *
 * karaoke_package            // カラオケパックGIT
 *
 * 注意点：
 * ・本関数のpageは画面表示上のページと連動していません．
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param crid CRID
 * @param displayType
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return シノプシス情報
 */
function getKaraokeLicenseSynopsis(crid, displayType, page, ispid, mode, age) {
	var ret = null;
	// TSVファイルを要求
	ret = browser.transmitTextDataOverIP(STUB_PATH + "karaokePackageSynopsis.tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForLongSynopsis(tsvList[i]);
	}

	return result[page];
}

/**
 * [modify 11/18 戻り値にcid_from_clientを追加しました]
 * [modify 5/16 変数名をbonusBuyFlagからvzoneFlagに変更しました]
 * [modify 5/16 変数名をbonusBuyFlagを別途追加しました。すみません]
 * buyConfirmの結果を格納します。
 * 
 * @param nextcom 購入要：buy_license 既に見られる：buy_complete
 * @param requestPin PIN入力が必要な場合：１．それ以外：0
 * @param session 通信用パラメータ[or BLANK]
 * @param purchaseId 通信用パラメータ[or BLANK]
 * @param cid 通信用パラメータ（VODの場合）[or BLANK]
 * @param bonusBuyFlag 通信用パラメータ[or 0]
 * @param vzoneFlag Vゾーンライセンスで購入：1．通常購入：0（VODの場合）
 * @param channelId 通信用パラメータ（TVの場合）[or BLANK]
 * @param programUrl buy_completeで単品VODのみProgramURL
 * @param mcLicenses buy_completeで単品チャンネル、チャンネルパック、
 *                  チャンネルSVODの場合のみMCライセンスID配列 or null
 * @param cid_from_client メタデータに登録されているcid [or BLANK]
 */
function ResultBuyConfirm(nextcom, requestPin, session, purchaseId, cid, 
				bonusBuyFlag, vzoneFlag, channelId, programUrl, mcLicenses, cid_from_client) {
  this.nextcom = nextcom;
  this.requestPin = requestPin;
  this.session = session;
  this.purchaseId = purchaseId;
  this.cid = cid;
  this.bonusBuyFlag = bonusBuyFlag;
  this.vzoneFlag = vzoneFlag;
  this.channelId = channelId;
  this.programUrl = programUrl;
  this.mcLicenses = mcLicenses;
  this.cid_from_client = cid_from_client;
}

/**
 * [modify 11/18 引数にcidを追加しました]
 * 
 * 購入確認を実行します。
 * 
 * @param purchaseId
 * @param cid
 * @param displayType
 * @param drmid
 * @param key
 * @return ResultBuyConfirm 購入確認結果
 */
function buyConfirm(purchaseId, cid, displayType, drmid, key) {
  // purchaseIdの末尾の数字をtsvの取得行数とする
  // return new ResultBuyConfirm("buy_license", 1, "", null);
  // ★purchaseIdのスプリットに関しては要確認
	return getBuyConfirm( STUB_PATH + "buyConfirm_", displayType );
}

/**
 * 購入処理結果情報を格納します。
 * 
 * @param nextcom 正常：buy_complete
 * @param programUrl 単品VODのみProgramURL
 * @param mcLicenses 単品チャンネル、チャンネルパック、チャンネルSVODの場合のみ
 *                  MCライセンスID配列  or null
 */
function ResultBuyLicense(nextcom, programUrl, mcLicenses) {
  this.nextcom = nextcom;
  this.programUrl = programUrl;
  this.mcLicenses = mcLicenses;
}

/**
 * 購入処理を実行します．
 * 本関数の前に必ずbuyConfirmを呼ぶ必要があります。
 *
 * @param resultConfirm buyConfirmの結果で受け取った
 *         resultBuyConfirmオブジェクト
 * @param pin 入力されたPINコード．PIN要求が無い場合：null
 * @param displayType displayType
 * @param drmid DRMID
 * @param key KEY
 * @return ResultBuyLicense 購入処理結果
 */
function buyLicense(resultConfirm, pin, displayType, drmid, key) {
	// return new ResultBuyLicense("buy_complete", 
	// 			      "programUrl", 
	// 			      new Array("license1", "license2"));

	return getBuyLicense( STUB_PATH + "buyLicense_", displayType );
}

/**
 * pinStatusの結果を格納します。
 *
 * @param nextcom 旧PIN入力が必要：pin_update，新PINのみでよい：pin_setting，エラー：それ以外[or BLANK]
 */
function ResultPinStatus(nextcom) {
  this.nextcom = nextcom;
  
}

/**
 * PIN変更確認を実行します。
 *
 * @param drmid DRMID
 * @param key KEY
 * @return ResultPinStatus PIN変更確認結果
 */
function pinStatus(drmid, key) {
	var filename = "pinStatus.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	//return ResultPinUpdateConfirm( tsvList[0], tsvList[1] );
	//return new ResutPinStatus("pin_update");
	return new ResultPinStatus( tsvList[0] );
}

/**
 * PIN設定処理結果情報を格納します。
 * 
 * @param nextcom 正常：pin_setting_complete，失敗：左記以外[or BLANK]
 */
function ResultPinSetting(nextcom) {
  this.nextcom = nextcom;
}

/**
 * PIN変更処理結果情報を格納します。
 * 
 * @param nextcom
 *    PIN変更完了：pin_update_complete，失敗：先記以外[or BLANK]
 */
function ResultPinUpdate(nextcom) {
  this.nextcom = nextcom;
}

/**
 * PIN設定処理を実行します．resultPinStatus.nextcom=pin_settingの場合に呼び出します．
 * 本関数の前に必ずpinStatusを呼ぶ必要があります。
 *
 * @param newPin 新PIN．PINを設定しない場合：null
 * @param drmid DRMID
 * @param key KEY
 * @return ResultPinSetting PIN更新結果
 */
function pinSetting(newPin, drmid, key) {
  // return new ResultPinSetting("pin_setting_complete");
	var filename = "pinSetting.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	return new ResultPinSetting( tsvList[0] );
}

/**
 * PIN変更処理を実行します．resultPinStatus.nextcom=pin_updateの場合に呼び出します．
 * 本関数の前に必ずpinStatusを呼ぶ必要があります。
 *
 * @param oldPin 旧PIN．必須です．
 * @param newPin 新PIN．PINを設定しない場合：null
 * @param drmid DRMID
 * @param key KEY
 * @return ResultPinUpdate PIN更新結果
 */
function pinUpdate(oldPin, newPin, drmid, key) {
  // return new ResultPinUpdate("pin_update_complete");
	var filename = "pinUpdate.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	return new ResultPinUpdate( tsvList[0] );
}

/**
 * 購入済みチャンネル一覧を取得します．
 *
 * 本関数は，内部で下記の処理を実行します．
 * 1.通信AGTより購入済みCHのserviceID(10進)リストを取得
 *   -1ページごと（9）のリストとtotal件数を都度取得
 * 2.検索I/Fよりチャンネル毎の情報を取得
 *   -5個，4個で2回の検索で取得
 *   指定したserviceIDの順序をキープして返却してくれるはず
 * 3.serviceIDをキーに上記取得情報を上からマージ．
 * ※注意点
 * ・購入ライセンスが存在し，メタが無い場合，serviceIdのみが設定された
 *   ContentInforamtionとなります．
 *
 * @param page 取得するページ番号（0開始）
 * @param age 検索時の最低視聴年齢
 * @return PageInformation 
 */
function getActiveChannels(page, age) {
	return getMaxLines(STUB_PATH + "activeChannels.tsv",
						 page, 9 ,ACTIVE_CHANNELS_LIST_NUM_PER_PAGE, ACTIVE_CHANNELS_TOTAL);
}

/**
 * [modify 6/9 引数にISPID、端末拡張設定を追加]
 *
 * 視聴可能VOD一覧を取得します．
 *
 * 本関数は，内部で下記の処理を実行します．
 * 1.通信AGTより視聴可能VODのPurchaseID＋タイトルリストを取得
 *   -1ページごと（9）のリストとtotal件数を都度取得
 * 2.通信AGTよりVODごとの情報を取得
 *   -5個，4個で2回の検索で取得（視聴可能期限情報をもらう）
 * 3.PurchaseIDをキーに上記取得情報を上からマージ．
 *   指定したPurchaseIDの順序をキープして返却してくれるはず
 * 
 * ※注意点
 * ・視聴可能期間はContentInformation.contentDetail.activeLicense.licenseEnd
 *   に格納されます．
 * ・視聴可能ライセンスが存在し，メタが無い場合，タイトル，purchaseIdのみが
 *   設定されたContentInforamtionとなります．
 * 
 * @param page 取得するページ番号（0開始）
 * @param age 検索時の最低視聴年齢
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @return PageInformation 
 */
function getActiveListVod(page, age, ispid, mode) {
	return getMaxLines(STUB_PATH + "activeListVod.tsv",
						 page, 9 ,ACTIVE_LIST_VOD_NUM_PER_PAGE, ACTIVE_LIST_VOD_TOTAL);
}

/**
 * VOD購入履歴一覧の情報を取得します．
 * 
 * @param amount 月の購入合計金額 [or 0]
 * @param pageInformation コンテンツ情報配列 [or null]
 */

function BuyListPageInformation(amount, pageInformation) {
	this.amount = amount;
	this.pageInformation = pageInformation;
}

/**
 * VOD購入履歴一覧を取得します．
 *
 * 本関数は，内部で下記の処理を実行します．
 * 1.通信AGTより購入履歴VODの情報を取得
 * 
 * ※注意点
 * ・本関数の戻り値のContentInformationには，crid,displayTypeが格納されません．
 * 
 * @param date 対象年月が正しく設定されたDateオブジェクト
 * @param page 取得するページ番号（0開始）
 * @param age 検索時の最低視聴年齢
 * @return BuyListPageInformation
 */
function getBuyList(date, page, age) {
	var id = String(date.getMonth() % 2);

//／靴靴TSVを作る 購入日[TAB]タイトル[TAB]価格[CRLF]
//amount取得は別のTSVにする

	var buylist_total_filename = "buyList_total_";
	var buylist_filename= "buyList_";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + buylist_total_filename + id + ".tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var t = tsvList[0].split("\t");
	var amount = t[0];
	var totalCount = t[1];

	var resultList = getBuyListCI(STUB_PATH + buylist_filename, id, page);
	var pi = new PageInformation(totalCount, resultList);
	
	return new BuyListPageInformation( amount, pi );
}

/*
 * [modify 6/9 引数にISPID、端末拡張設定を追加]
 *
 * 購入済みプレミアム一覧を取得します．
 *
 * 本関数は，内部で下記の処理を実行します．
 * 1.通信AGTより購入済みプレミアムのPurchaseID＋タイトルリストを取得
 * 2.検索I/Fよりプレミアムコンテンツごとの情報を取得
 * 3.PurchaseIDをキーに上記取得情報を上からマージ
 * 
 * ※注意点
 * ・視聴可能ライセンスが存在し，メタが無い場合，タイトル，purchaseIdのみが
 *   設定されたContentInforamtionとなります．
 * 
 * @param page 取得するページ番号（0開始）
 * @param age 検索時の最低視聴年齢
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @return PageInformation
 */
function getActivePremiums(page, age, ispid, mode) {
	// ここは堤
	return getMaxLines(STUB_PATH + "activePremiums.tsv",
						 page, 9 ,ACTIVE_LIST_PREMIUM_NUM_PER_PAGE, ACTIVE_LIST_PREMIUM_TOTAL);

}

/**
 * cancelConfirmの結果を格納します。
 *
 * @param nextcom キャンセル要：cancel_license キャンセル不要：cancel_complete
 * @param session 通信用パラメータ[or BLANK]
 * @param purchaseId 通信用パラメータ[or BLANK]
 * @param licenseName 解約ライセンス名
 * @param requestPin PIN入力が必要な場合：１．それ以外：0
 */
function ResultCancelConfirm(nextcom, session, purchaseId, licenseName, requestPin) {
  this.nextcom = nextcom;
  this.session = session;
  this.purchaseId = purchaseId;
  this.licenseName = licenseName;
  this.requestPin = requestPin;
}

/**
 * 解約確認を実行します。
 * 
 * @param purchaseId 解約するpurchaseId
 * @param licenseType licenseType
 * @param drmid DRMID
 * @param key KEY
 * @return ResultCancelConfirm 解約確認結果
 */
function cancelConfirm(purchaseId, licenseType, drmid, key) {
	return getCancelConfirm( STUB_PATH + "cancelConfirm_", licenseType );
}

/**
 * プレミアム解約結果情報を格納します。
 *
 * @param nextcom 正常：cancel_complete
 */
function ResultCancelLicense(nextcom) {
  this.nextcom = nextcom;
}

/**
 * 購入済みプレミアムの解約処理を実行します．．
 *
 * @param resultConfirm cancelConfirmの結果で受け取った
 *         resultCancelConfirmオブジェクト
 * @param pin 入力されたPINコード．PIN要求が無い場合：null
 * @param licenseType licenseType
 * @param drmid DRMID
 * @param key KEY
 * @return ResultCancelLicense
 */
function cancelLicense(resultConfirm, pin, licenseType, drmid, key) {
	// return new ResultBuyLicense();
	// ★purchaseIdのスプリットに関しては要確認
	return getCancelLicense( STUB_PATH + "cancelLicense_", licenseType );
}

/**
 * カラオケ新譜用ジャンルリストを取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param child 子ジャンルの識別子
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 * 
 */
function getGenresForKaraokeNewArrival(ispid, mode, age) {
	var filename = "mainGenre_karaoke_newArrival.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * カラオケ特集用ジャンルリストを取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 * 
 */
function getGenresForKaraokePickUp(ispid, mode, age) {
	var filename = "mainGenre_karaoke_PickUp.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}
/**
 * カラオケランキング用ジャンルリストを取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 * 
 */
function getGenresForKaraokeRanking(ispid, mode, age) {
	var filename = "mainGenre_karaoke_Ranking.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * カラオケ年別用ジャンルリストを取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 * 
 */
function getGenresForKaraokeGeneration(ispid, mode, age) {
	var filename = "mainGenre_karaoke_Generation.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * カラオケジャンル検索用ジャンルリストを取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 * 
 */
function getGenresForKaraokeGenre(ispid, mode, age) {
	var filename = "mainGenre_karaoke_Genre.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * 月ジャンルを指定してカラオケ新譜検索を実行します．
 * PageInformation内部のContentInformationにはcrid, displayType, BasicDescription,
 * Period,Icon, sort, karaokeInformationのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param genre ジャンル文字列
 * @param sort ソートキー
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeNewArrival(genre, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeNewArrival.tsv",
						 page, 9 ,KARAOKE_LIST_NUM_PER_PAGE, KARAOKE_CONTENT_TOTAL);
}

/**
 * カラオケ特集画面に表示するGITリストを取得します．
 * 処理はカラオケトップパレードと同一ですが，タイトルの3点リーダ位置が違います．
 * 本関数でGITを取得した後，searchKaraokeMemberOfにより特集PIT一覧を取得します．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * 内部処理フロー
 * ・g_parade_cridが設定されていない場合，サーバよりCRIDを取得．
 * ・引数の検索オプションを指定してg_parade_cridに含まれる特集GITリストを取得．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・サーバから返却されるg_parade_cridの値は仕様上ランダムなため，BMLを跨いだ
 *   パレードリストの利用にはg_parade_cridの引渡しが必要になります．
 *
 * @param genre ジャンル文字列
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function searchKaraokePickUpGIT(genre, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokePickUpGIT.tsv",
						 page, 9 ,KARAOKE_GIT_LIST_NUM_PER_PAGE, KARAOKE_GIT_CONTENT_TOTAL);
}

/**
 * カラオケトップのパレードリストを取得します．
 *
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 内部処理フロー
 * ・g_parade_cridが設定されていない場合，サーバよりCRIDを取得．
 * ・引数の検索オプションを指定してg_parade_cridに含まれる特集GITリストを取得．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・サーバから返却されるg_parade_cridの値は仕様上ランダムなため，BMLを跨いだ
 *   パレードリストの利用にはg_parade_cridの引渡しが必要になります．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function getKaraokeParade(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "karaokeParade.tsv",
						 page, 5 ,PARADE_NUM_PER_PAGE, KARAOKE_PARADE_TOTAL);
}


/**
 * CRIDを指定してカラオケコンテンツの詳細Synopsisを取得します．
 * 戻り値のLongSynopsisにはサーバで設定されたバイト数分のSynopsisが格納されます．
 *
 * 有効なdisplayTypeは以下です。
 *
 * karaoke_program           // カラオケ曲紹介
 *
 * 注意点：
 * ・本関数のpageは画面表示上のページと連動していません．
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param crid CRID
 * @param displayType
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return シノプシス情報
 */
function getKaraokeSynopsis(crid, displayType, page, ispid, mode, age) {
	var ret = null;
	// TSVファイルを要求
	if (displayType == "karaoke_program") {
		ret = browser.transmitTextDataOverIP(STUB_PATH +
                                   "karaokeProgramSynopsis.tsv", null, "EUC-JP");
	} else if (displayType = "karaoke_series") {
		ret = browser.transmitTextDataOverIP(STUB_PATH +
                                   "karaokeSeriesSynopsis.tsv", null, "EUC-JP");
	} else {
		return null;
	}
	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForLongSynopsis(tsvList[i]);
	}

	return result[page];
}

/**
 * 特集GITのCRIDを指定して含まれるカラオケ曲検索を実行します．
 * ContentInformationにはcrid, displayType, Period, sort, karaokeInformation
 * のみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param crid GITのCRID
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeMemberOf(crid, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeMemberOf.tsv",
						 page, 9 ,KARAOKE_LIST_NUM_PER_PAGE, MEMBER_OF_KARAOKE_TOTAL);
}

/**
 * ジャンルを指定してカラオケランキング検索を実行します．
 * ContentInformationにはcrid, displayType, Period, sort, karaokeInformation
 * のみ格納されます．
 *
 * 本検索は他の検索と違い，ジャンルごとにランキングGITが配置される構造の
 * のため，内部で下記2回の通信を行います．
 *
 * ・ジャンルを指定して，カラオケランキングGITのContentInformationを取得する．
 * ・ランキングGITCRID，ページ指定，検索条件を指定しコンテンツリストを取得する．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param genre ジャンル文字列
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeRanking(genre, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeRanking.tsv",
						 page, 9 ,KARAOKE_LIST_NUM_PER_PAGE, KARAOKE_CONTENT_TOTAL);
}

/**
 * 年ジャンルを指定してカラオケ年別検索を実行します．
 * PageInformation内部のContentInformationにはcrid, displayType, BasicDescription,
 * Period,Icon, sort, karaokeInformationのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param genre ジャンル文字列
 * @param sort ソートキー
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeGeneration(genre, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeGeneration.tsv",
						 page, 9 ,KARAOKE_LIST_NUM_PER_PAGE, KARAOKE_CONTENT_TOTAL);
}

/**
 * ジャンルを指定してカラオケジャンル検索を実行します．
 * PageInformation内部のContentInformationにはcrid, displayType, BasicDescription,
 * Period,Icon, sort, karaokeInformationのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param genre ジャンル文字列
 * @param sort ソートキー
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeGenre(genre, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeGenre.tsv",
						 page, 9 ,KARAOKE_LIST_NUM_PER_PAGE, KARAOKE_CONTENT_TOTAL);
}

/**
 * 文字列を指定してカラオケ歌手検索を実行します．
 * PageInformation内のContentInformationにはtitle(表示用) artistName（検索用）
 * のみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param artist 歌手名の断片
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeArtistList(artist, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeArtistList.tsv",
						 page, 9 ,KARAOKE_ARTIST_LIST_NUM_PER_PAGE,
						 KARAOKE_ARTIST_TOTAL);
}

/**
 * 歌手名の文字列を指定してカラオケ曲検索を実行します．
 * PageInformation内部のContentInformationにはcrid, displayType, BasicDescription,
 * Period,Icon, sort, karaokeInformationのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param artist 歌手名
 * @param sort ソートキー
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeByArtist(artist, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeByArtist.tsv",
						 page, 9 ,KARAOKE_BY_ARTIST_LIST_NUM_PER_PAGE,
						 KARAOKE_BY_ARTIST_TOTAL);
}

/**
 * 曲名の文字列を指定してカラオケ曲検索を実行します．
 * PageInformation内部のContentInformationにはcrid, displayType, BasicDescription,
 * Period,Icon, sort, karaokeInformationのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・デフォルトのソートキーはメインジャンルのsortを指定して下さい．
 *
 * @param title 曲名の断片
 * @param sort ソートキー
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeByTitle(title, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeByTitle.tsv",
						 page, 9 ,KARAOKE_BY_TITLE_LIST_NUM_PER_PAGE,
						 KARAOKE_BY_TITLE_TOTAL);
}

/**
 * 4桁のIDを指定してカラオケID検索を実行します．
 * PageInformation内部のContentInformationにはcrid, displayType, BasicDescription,
 * Period,Icon, sort, karaokeInformationのみ格納されます．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param id ID(4桁)
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeIdList(id, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeId.tsv",
						 page, 9 ,KARAOKE_LIST_NUM_PER_PAGE, KARAOKE_CONTENT_TOTAL);
}

/**
 * 5桁のIDを指定してカラオケID検索を実行します．
 * 戻り値のPageInformationに含まれるContentInformationは必ず１つで，全ての情報
 * が格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param id ID(5桁)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function searchKaraokeIdDetail(id, ispid, mode, age) {
	// idの剰余をtsvの取得行数とする
	var index = id % KARAOKE_CONTENT_TOTAL;

	var result = new PageInformation(1, new Array(getOneContent(STUB_PATH + "getKaraokeContentDetail.tsv", index)));
	result.contentList[0].contentDetail.packPurchaseLicense
		= getPL(STUB_PATH +"karaokePurchaseLicense.tsv");
	return result;
}

/**
 * [10/20 modify] Icon/deliveryパース処理追加
 * 
 * CRIDを指定してカラオケコンテンツ詳細情報を取得します．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * 戻り値のContentInformationには全ての情報が格納されます．
 *
 * 有効なdisplayTypeは以下です。
 * karaoke_program           // カラオケ曲紹介
 * karaoke_series            // カラオケ特集GIT←特集タイトル取得用
 *
 * @param crid CRID
 * @param displayType
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getKaraokeContentDetail(crid, displayType, ispid, mode, age) {
	// CRIDの末尾の数字をtsvの取得行数とする
	var token = crid.split("_");
	var result =  getOneContent(STUB_PATH + "getKaraokeContentDetail.tsv",
								token[token.length - 1]);
	result.contentDetail.packPurchaseLicense
		= getPL(STUB_PATH +"karaokePurchaseLicense.tsv");
	return result;
}

/**
 * [10/20 modify] uid追加
 * 
 * カラオケの情報を保持します．
 *
 * @param artistName アーティスト名
 * @param titleAsNext 再生中情報表示バーの次曲領域向けタイトル
 * @param titleAsReserve 予約用の3点リーダなしのタイトル
 * @param titleAsSearch 全画面再生中のID5桁検索結果用タイトル
 * @param uid カラオケ予約順を特定するID
 */
function KaraokeInformation (artistName, titleAsNext, titleAsReserve, titleAsSearch, uid) {
	this.artistName = artistName;
	this.titleAsNext = titleAsNext;
	this.titleAsReserve = titleAsReserve;
	this.titleAsSearch = titleAsSearch;
	this.uid = uid;
}

/**
 * カラオケ曲を予約リストの末尾に追加します．
 * 登録結果がNGの場合，エラー情報が追加されます．
 *
 * @param contentInfo カラオケコンテンツ情報
 * @param drmid
 * @param key
 * @return 追加完了："OK" | 予約リスト満："FULL" | エラー："NG"
 */
function addLastKaraokeQueue(contentInfo, drmid, key) {
	// return "OK";
	
	var apiId = "077";
	g_errors = new Array();
	
	// カラオケコンテンツがnullの場合はNGを返却
	if (contentInfo == null) {
		addError(new Error(apiId, "03", ERROR_USER_DB, ""));
		return "NG";
	}
	
	// 予約リストが最大値の場合はFULLを返却
	if (kQueue.length >= KARAOKE_RESERVATION_LIST_LIMIT) {
		return "FULL";
	}
	
	// カラオケコンテンツを正常に追加できた場合はOKを返却
	kQueue[kQueue.length] = contentInfo;
	return "OK";
}

/**
 * カラオケ曲を予約リストの先頭に追加します．
 * 登録結果がNGの場合，エラー情報が追加されます．
 *
 * @param contentInfo カラオケコンテンツ情報
 * @param drmid
 * @param key
 * @return 追加完了："OK" | 予約リスト満："FULL" | エラー："NG"
 */
function addFirstKaraokeQueue(contentInfo, drmid, key) {
	// return "OK";
	var apiId = "078";
	g_errors = new Array();
	
	// カラオケコンテンツがnullの場合はNGを返却
	if (contentInfo == null) {
		addError(new Error(apiId, "03", ERROR_USER_DB, ""));
		return "NG";
	}
	
	// 予約リストが最大値の場合はFULLを返却
	if (kQueue.length >= KARAOKE_RESERVATION_LIST_LIMIT) {
		return "FULL";
	}
	
	// 予約リスト配列を１つずつ後ろにずらす
	for (var i = kQueue.length; i > 0; i--) {
		kQueue[i] = kQueue[i - 1];
	}
	
	// 予約リストの先頭にカラオケコンテンツを設定
	kQueue[0] = contentInfo;
	
	// カラオケコンテンツを正常に追加できた場合はOKを返却
	return "OK";
}

/**
 * [10/20 modify] 関数名変更．uid指定で予約曲削除．
 * 
 * カラオケ曲を予約リストから削除します．
 * 登録結果がNGの場合，エラー情報が追加されます．
 *
 * @param drmid
 * @param key
 * @param karaokeContentInfo カラオケコンテンツ情報
 * @return 削除完了："OK" | エラー："NG"
 */
//function removeFirstKaraokeQueue(karaokeContentInfo, drmid, key) {
function removeKaraokeReservation(karaokeContentInfo, drmid, key) {

	// return "OK";
	
	var apiId = "079";
	g_errors = new Array();
	
	// 予約リストが設定されていない場合はNGを返却
	if (kQueue.length == 0) {
		addError(new Error(apiId, "03", ERROR_USER_DB, ""));
		return "NG";
	}
	
	var tmpArray = new Array;		// 予約リスト配列置換用配列
	var index = 0 ;
	
	for (var i = 0; i < kQueue.length; i++) {
		
		if (kQueue[i].karaokeInformation.uid == karaokeContentInfo.karaokeInformation.uid){
			var temp = kQueue[i].karaokeInformation.uid;
			continue;
		}
		tmpArray[index] = kQueue[i];
		index++;
	}
	
	// 置換用配列を予約リスト配列に設定
	kQueue = tmpArray;
	
	return "OK";
}

/**
 * [10/20 modify] uidパーサ処理追加
 * 
 * カラオケ曲予約リストを指定のページごとに取得します．
 * 返却オブジェクトにはcrid, artistName, title, uid のみがセットされます
 *
 * @param page 取得するページ番号(0開始)
 * @param drmid
 * @param key
 * @return コンテンツ情報．
 */
function getKaraokeReservationList(page, drmid, key){
	
	var apiId = "081";
	g_errors = new Array();

	var result = new Array();		// 指定ページ格納用配列
	var startIndex = page * KARAOKE_RESERVATION_LIST_NUM_PER_PAGE;				// 指定ページ先頭位置
	var endIndex = startIndex + KARAOKE_RESERVATION_LIST_NUM_PER_PAGE;		// 指定ページ終端位置
	
	addError(new Error(apiId, "03", ERROR_USER_DB, ""));
	
	var j = 0;
	for (var i = startIndex;((i < endIndex) && (i < kQueue.length)); i++) {
		result[j] = kQueue[i];
		j++;
	}
	return new PageInformation(kQueue.length, result);
}

/**
 * [10/20 modify] uidパーサ処理追加
 * 
 * [modify 5/13 予約リスト情報は１行に次曲の情報も設定するよう変更]
 * カラオケ曲予約リストを先頭から１件取得します．
 * 返却オブジェクトにはcrid, artistName, title, titleAsNext,
 * programUrl のみがセットされます．
 * 
 * ※注意点
 * ・titleAsNextには次曲の表示情報が格納されます．存在しない場合はブランクです．
 * ・ライセンス切れの場合，programUrlはセットされません．
 *
 * @param drmid
 * @param key
 * @return コンテンツ情報．
 */
function getKaraokeQueue(drmid, key){

	var apiId = "082";
	g_errors = new Array();
	
	addError(new Error(apiId, "03", ERROR_USER_DB, ""));
	
	var result = new Array();
	for (var i = 0;((i < KARAOKE_QUEUE_NUM_PER_PAGE) && (i < kQueue.length)); i++) {
		result[i] = kQueue[i];
	}
	return new PageInformation(kQueue.length, result);
}

////////////////////////// NOD関数群(ここから) ////////////////////////////////

// オブジェクト定義
/**
 * 規約ダイアログの規約情報を保持します．
 * totalSizeが0の場合，regulationは長さ0の文字列です．
 * totalCountは規約情報の表示に使うPage数とは違います．
 *
 * @param totalCount 全ページ数
 * @param regulation regulationの一部分
 */
function RegulationInformation(totalCount, regulation) {
  this.totalCount = totalCount;
  this.regulation = regulation;
}

// 関数定義
/**
 * NODトップのパレードリストを取得します．
 *
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 内部処理フロー
 * ・g_parade_cridが設定されていない場合，サーバよりCRIDを取得．
 * ・引数の検索オプションを指定してg_parade_cridに含まれるPITリストを取得．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 * ・サーバから返却されるg_parade_cridの値は仕様上ランダムなため，BMLを跨いだ
 *   パレードリストの利用にはg_parade_cridの引渡しが必要になります．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function getNodParade(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "nodParade.tsv",
						 page, 5 ,PARADE_NUM_PER_PAGE, NOD_PARADE_TOTAL);
}

/**
 * NODトップのメニューから見逃し番組画面，ニュース画面へ遷移した際に
 * ジャンルIDを指定してウィザードGITを取得します．
 *
 * 戻り値のPageInformationに含まれるContentInformationは必ず１つになります．
 * 戻り値のPageInformation内のContentInformationにはcrid, displayType, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param genre ジャンル文字列
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getNodWizardGIT(genre, ispid, mode, age) {
	// genreの末尾の数字をtsvの取得行数とする
	var token = genre.split(".");
	
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "getNodWizardGIT.tsv." + getZeroNum( token[token.length - 1], 2 ), null, "EUC-JP");

	// レコード単位で配列に格納
	var contentList = ret[2].split("\r\n");

	return new PageInformation(1, new Array(tsvParseForCIList(contentList[0])));
}

/**
 * NOD新着検索用のジャンル情報配列を取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 * 
 */
function getGenresForNodNewArrival(ispid, mode, age) {
	var filename = "mainGenre_nod_newArrival.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * NODランキング検索用のジャンル情報配列を取得します．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 * 
 */
function getGenresForNodRanking(ispid, mode, age) {
	var filename = "mainGenre_nod_Ranking.tsv";

	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * NODジャンル検索用のジャンル情報配列を取得します．
 * メインジャンルのリストをとる場合はchildに"ROOT"を指定してください．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param child 子ジャンルの識別子
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return GenreInformationの配列
 */
function getGenresForNodGenre(child, ispid, mode, age) {
	var filename = "";
	if (child == "ROOT") {
		filename = "mainGenre_nod_Genre.tsv";
	} else {
		filename = "subGenre_nod_" + child + ".tsv";
	}
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH + filename, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForGenre(tsvList[i]);
	}

	return result;
}

/**
 * [10/6 deleted] 
 *
 * NODお知らせ画面の新着情報リストを取得します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 
function getNodNewAnnouncements(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "getNodNewAnnouncements.tsv",
						 page, 9 ,ANNO_LIST_NUM_PER_PAGE, NOD_NEW_ANNO_TOTAL);
}
*/

/**
 * [10/6 deleted] 
 * NODお知らせ画面のメンテナンス情報リストを取得します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 
function getNodMaintenances(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "getNodMaintenances.tsv",
						 page, 9 ,ANNO_LIST_NUM_PER_PAGE, NOD_MAINTENANCES_TOTAL);
}
*/

/**
 * [10/6 deleted] 
 *
 * NODお知らせ画面のサポート情報リストを取得します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sortのみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 
function getNodSupports(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "getNodSupports.tsv",
						 page, 9 ,ANNO_LIST_NUM_PER_PAGE, NOD_SUPPORTS_TOTAL);
}
*/

/**
 * NOD規約ダイアログに表示する規約情報を取得します．
 * NODコンテンツに対して購入ボタン押下時に利用します．
 * 戻り値のRegulationInformationにはサーバで設定されたバイト数分の規約情報が格納されます．
 * 注意点：
 * ・本関数のpageは画面表示上のページと連動していません．
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param regulationUrl 規約情報txtファイルURL
 * @param page 取得するページ番号（0開始）
 * @return コンテンツ情報．
 */
function getRegulationInformation(regulationUrl, page) {
	var ret = null;
	// TSVファイルを要求
	ret = browser.transmitTextDataOverIP(STUB_PATH + "getRegulationInformation.tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForRegulationInformation(tsvList[i]);
	}

	return result[page];
}

/**
 * [10/6 modify] NODのお知らせ情報取得処理を１関数に統一しました。
 *               今後他関数にも活用できるよう、名称にNODは挿入していません。
 *
 * NODお知らせ画面のサポート情報リストを取得します．
 * PageInformation内部のContentInformationにはcrid, type, BasicDescription,
 * Period, sort, announcementTypeのみ格納されます．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param genre ジャンル文字列
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 */
function searchAnnouncementSupports(genre, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchAnnouncementSupports.tsv",
						 page, 9 ,ANNO_LIST_NUM_PER_PAGE, ANNO_SUPPORTS_TOTAL);
}


////////////////////////// NOD関数群(ここまで) ////////////////////////////////


////////////////////////// STEP2.5関数群(ここから) ////////////////////////////////



/**
 * ブックマークを登録します．
 * 通信Agtのmark_addにアクセスします．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します.
 * ・準正常系(ブックマーク重複と，登録数上限)の場合には，
 *   エラーオブジェクトのError.typeの下1桁に「5」を設定します．
 *
 * @param contentInfo ブックマーク登録を行うコンテンツ情報
 * @param drmid DRMID
 * @param key KEY
 * @return ResultBookmark情報
 */
function addBookmark(contentInfo, drmid, key) {
	
	// ブックマーク配列を１つずつ後ろにずらす
	for (var i = bQueue.length; i > 0; i--) {
		bQueue[i] = bQueue[i - 1];
	}
	
	// 予約リストの先頭にカラオケコンテンツを設定
	bQueue[0] = contentInfo;
	return new ResultBookmark("mark_add_complete");
}


/**
 * お気に入りリストを取得します．
 * 通信Agtのmark_getにアクセスしたあと，取得したcridリストを用いて検索I/Fより
 * コンテンツ情報を取得します．
 * @param page 取得するページ番号(0開始)
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢
 */
function getBookmark(page, ispid, mode, age) {
	var result = new Array();
	for (var i = 0; i < bQueue.length; i++){
		result[i] = bQueue[i];
	}
	return new PageInformation(bQueue.length, result);
}


/**
 * ブックマークから1件削除します．
 * 通信Agtのmark_delにアクセスします．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します.
 *
 * @param crid 削除するcrid
 * @param drmid DRMID
 * @param key KEY
 * @return ResultBookmark情報
 */
function deleteBookmark(crid, drmid, key) {
	var tempArray = new Array();
	var index = 0;
	for (var i = 0; i < bQueue.length; i++){
		if (bQueue[i].crid == crid){
			continue;
		}
		tempArray[index] = bQueue[i];
		index++;
	}
	bQueue = tempArray;
	return new ResultBookmark("mark_del_complete");
}

/**
 * ブックマークから全件削除します．
 * 通信Agtのmark_delallにアクセスします．
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します.
 *
 * @param drmid DRMID
 * @param key KEY
 * @return ResultBookmark情報
 */
function deleteBookmarkAll(drmid, key) {
	bQueue = new Array();
	return new ResultBookmark("mark_delall_complete");
}


/**
 * お知らせダイアログのタイトル，CRIDを取得します．
 * 戻り値のpageInformationには1件のお知らせ情報が返却されます．
 * pageInformation内のcontentInformationにはcrid, title displayStart, endが
 * 格納されます．
 * また，synopsisは返却されないので，getNoticeSynopsisにより取得してください．
 * pageInformation.lengthには総数が格納されます． 
 *
 * @param initflag 初回取得判定フラグ
 * @param crid 直前に読み終わったCRID．先頭の場合はnullを指定．
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢
 * @param drmid DRMID
 * @param key KEY
 * @return pageInformation
 */
function getNotice(initflag, crid, ispid, mode, age, drmid, key) {

	var result = new Array();
	// TSVファイルを要求
	if (crid.length == 0){
		result[0] = getOneContent(STUB_PATH + "getNotice.tsv",0);
	} else {
		var token = crid.split("_");
		var next = 0;
		for (var i = 0; i < 90 ; i++){
			if (token[token.length - 1] == i)
			{ next = i + 1; }
		}
		result[0] = getOneContent(STUB_PATH + "getNotice.tsv",next);
	}
	
	return new PageInformation(3 , result);
}


/**
 * お知らせダイアログのメッセージ本文を取得します．
 *
 * @param crid 本文を取得するCRID
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢
 * @return シノプシス情報
 */
function getNoticeSynopsis(crid, page, ispid, mode, age) {
	var apiId = "093";
	g_errors = new Array();
	
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH +
                                   "noticeSynopsis.tsv", null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");
	var result = new Array();
	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForLongSynopsis(tsvList[i]);
	}
	return result[page];
}


/**
 * 変更可能なプランリスト一覧を取得します．
 *
 * 本関数は，内部で下記の処理を実行します．
 * 1.通信AGTより変更可能なプランリストのプランコード，プラン名，価格を取得
 *   -1ページごと（9）のリストとtotal件数を都度取得
 * 2.返却されたプランコードからCRIDを生成
 *   -CRIDは「PLAN_CRID_PREFIX + plan_code」で生成する
 * 3.通信AGTよりプランごとの詳細情報を取得
 *   -5個，4個で2回の検索で取得（サムネイル，シノプシス等の情報をもらう）
 * 4.生成したCRIDをキーに上記取得情報を上からマージ．
 *   指定したCRIDの順序をキープして返却される.
 * 
 * ※注意点
 * ・変更可能プランが存在し，メタが無い場合，タイトル，価格のみが
 *   設定されたContentInforamtionとなります．
 * 
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢
 * @return PageInformation 
 */
function getEnableChangePlanList(page, ispid, mode, age) {
	var result = new Array();
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "getEnableChangePlanList.tsv", null, "EUC-JP");
	var lines = ret[2].split("\r\n");
	for (var i = page*9; i < lines.length - page*9-1; i++){
		result[i] = getOneContent(STUB_PATH + "getEnableChangePlanList.tsv",i);
	}
	return new PageInformation(lines.length-1 , result);
}


/**
 * CRIDを指定してプラン詳細情報を取得します．
 * プランの詳細で利用します．
 *
 * 注意点：
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * 戻り値のContentInformationには全ての情報が格納されます．
 *
 * 有効なdisplayTypeは以下です．
 * plan_detail           // プラン詳細PIT
 *
 * @param crid CRID
 * @param displayType
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return コンテンツ情報．
 */
function getPlanContentDetail(crid, displayType, ispid, mode, age) {
	var token = crid.split("_");
	return getOneContent(STUB_PATH + "getPlanContentDetail.tsv",
								token[token.length - 1]);
	
}

/**
 * CRIDを指定してプランの詳細Synopsisを取得します．
 * 戻り値のLongSynopsisにはサーバで設定されたバイト数分のSynopsisが格納されます．
 *
 * 有効なdisplayTypeは以下です．
 *
 * plan_detail            // プラン詳細PIT
 *
 * 注意点：
 * ・本関数のpageは画面表示上のページと連動していません．
 * ・エラー時はエラー情報を設定し，nullを返却します．
 *
 * @param crid CRID
 * @param displayType
 * @param page 取得するページ番号（0開始）
 * @param ispid ISPID
 * @param mode 端末拡張設定
 * @param age 検索時の最低視聴年齢．
 * @return シノプシス情報．
 */
function getPlanSynopsis(crid, displayType, page, ispid, mode, age) {
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(STUB_PATH +
                                   "planSynopsis.tsv", null, "EUC-JP");
	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");
	var result = new Array();
	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForLongSynopsis(tsvList[i]);
	}
	return result[page];
}


/**
 * プラン変更確認を実行します．
 * 
 * @param crid 変更先プランのCRID
 * @param drmid DRMID
 * @param key KEY
 * @return ResultPlanChange プラン変更結果
 */
function planChangeCheck(crid, drmid, key) {
	var token = crid.split("_");
	var ret = browser.transmitTextDataOverIP(STUB_PATH + "planChangeCheck.tsv.0" + token[token.length - 1] , null, "EUC-JP");
	var lines = ret[2].split("\r\n");
	var t = lines[0].split("\t");
	var i = 0;
	//var contractDate = stringToDateArray(t[8]);
	//return new ResultPlanChange(t[0], t[1], t[2], t[3], t[4], t[5], t[6], t[7], contractDate );
	return new ResultPlanChange(t[0], t[1], t[2], t[3], t[4], t[5], t[6], t[7], stringToDateArray(t[8]) , null);
}


/**
 * 操作音を設定します．
 *
 * @param volume_flag 操作音有：1 なし：0
 * @param drmid DRMID
 * @param key KEY
 * @return 成功："OK" 失敗："NG"
 */
function setSound(volume_flag, drmid, key) {
  return "OK";
}


/**
 * プラン変更処理を実行します．
 * 本関数の前に必ずplanChangeCheckを呼ぶ必要があります．
 * 
 * @param planCode planChangeCheck()の結果で受け取ったResultPlanChange.planCode
 * @param drmid DRMID
 * @param key KEY
 * @return ResultPlanChange プラン変更結果
 */
function planChangeActTask(planCode, drmid, key) {
  var ret = browser.transmitTextDataOverIP(STUB_PATH + "planChangeActTask.tsv" , null, "EUC-JP");
	var lines = ret[2].split("\r\n");
	var t = lines[0].split("\t");
	var i = 0;
	
	var licenses = null;

	if (t[9].length != 0) {
		licenses = t[9].split("/");
	}
	
	return new ResultPlanChange(t[0], "", "", "", t[4], t[5], t[6], "", stringToDateArray(t[8]) ,licenses );
}


/**
 * カラオケ利用履歴指定のページ毎に取得します．
 * 返却オブジェクトにはcrid, artistName, title displayStart/Endのみがセットされます
 *
 * @param page 取得するページ番号(0開始)
 * @param ispid
 * @param key
 * @return コンテンツ情報．
 *
 */
function getKaraokeHistory(page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "getKaraokeHistory.tsv",
						 page, 9 ,KARAOKE_LIST_NUM_PER_PAGE, KARAOKE_CONTENT_TOTAL);
}


/**
 * レジューム情報を登録します．
 * 
 * @param licenseId ActiveLicenseのlicenseId
 * @param stopposition mediaPlayerから取得したstopposition値
 * @param drmid DRMID
 * @param key KEY
 * @return 成功：OK 失敗 ：NG
 */
function setResume(licenseId, stopposition, drmid, key) {
  return "OK";
}


//////////////////////////    共通関数群    /////////////////////////////////

/**
 * パレードGIT取得処理
 * 要求電文の生成、要求電文送信、応答電文受信を行う。
 * getHomeParade()，getVodParade()，getTVParade()から呼び出される。
 *
 * @param mode 端末拡張設定
 * @param adult_disp アダルトフラグ
 * @param ispid ISPID
 * @param parental パレンタル値
 * @param genre ジャンル文字列
 * @param tsv_type TSVタイプ
 * @return パレードGIT取得結果
 */
function searchParadeGit(mode, adult_disp, ispid, parental, genre, tsv_type) {
	var param = "client_extension_type=" + mode;
	param += "\tadult_disp=" + adult_disp;
	param += "\tisp=" + ispid;
	param += "\tparental=" + parental;
	param += "\tperiod_type=display";
	param += "\tperiod_start_lt=" + getDateFormat(browser.addDate(new Date(), 1, 3));
	param += "\tperiod_start_gt=";
	param += "\tperiod_end_lt=";
	param += "\tperiod_end_gt=" + getDateFormat(new Date());
	param += "\tgenre=" + genre;
	param += "\ttsv_type=" + tsv_type;
	param += "\trandom=" + browser.random(RANDOM_RANGE); // 1〜Xの乱数
	
	return browser.transmitTextDataOverIP(AGENT_URI + AGT_SEARCH, param, "EUC-JP");
}

/**
 * パレード取得処理
 * getHomeParade()，getVodParade()，getTVParade()から呼び出される。
 * 要求電文の生成、要求電文送信、応答電文受信を行う。
 *
 * @param mode 端末拡張設定
 * @param adult_disp アダルトフラグ
 * @param ispid ISPID
 * @param parental パレンタル値
 * @param crid パレードGIT
 * @param tsv_type TSVタイプ
 * @param sort ソート条件
 * @param startPage 取得するレンジのスタート値
 * @return パレードGIT取得結果
 */
function searchParadeList(mode, adult_disp, ispid, parental, crid, tsv_type, startPage) {
	var param = "client_extension_type=" + mode;
	param += "\tadult_disp=" + adult_disp;
	param += "\tisp=" + ispid;
	param += "\tparental=" + parental;
	param += "\tperiod_type=display";
	param += "\tperiod_start_lt=" + getDateFormat(browser.addDate(new Date(), 1, 3));
	param += "\tperiod_start_gt=";
	param += "\tperiod_end_lt=";
	param += "\tperiod_end_gt=" + getDateFormat(new Date());
	param += "\tmember_list=" + crid;
	param += "\tsort=" + SORT_INDEX_ASC;
	param += "\ttsv_type=" + tsv_type;
	param += "\trange=" + startPage + "," + PARADE_NUM_PER_PAGE;
	
	return browser.transmitTextDataOverIP(AGENT_URI + AGT_SEARCH, param, "EUC-JP");
}

/**
 * パレードリストTSVパース処理
 * getHomeParade()，getVodParade()，getTVParade()から呼び出される。
 * 
 * @param パレードリストTSVの行配列(TSVヘッダ部＋TSVボディ部)
 * @param apiId 機能ID(「XX-YY-ZZZZZZZZZ」のXX部分)
 * @return PageInformation
 */
function parseForParadeList(lineList, apiId) {
	// 件数チェック
	if (lineList[0] == "0" || lineList[1] == null || lineList[1].length == 0) {
		return new PageInformation(0, new Array());
	}
	var ciList = new Array();
	
	var index = 0;
	for (var i = 1; i < lineList.length; i++) {
		if (lineList[i] == null || lineList[i].length == 0) {
			continue;
		}
		var line = lineList[i].split("\t");
		
		// TSVデータチェック(CRID)
		if (line[0] == null || line[0].length == 0) {
			addError(new Error(apiId, "03", "000000000", ERRORMSG_TSV));
			return null;
		}
		var bd = new BasicDescription(line[3], replaceLineCode(line[6]), line[4], "", line[2], line[5], "", "", replaceLineCode(line[7]), replaceLineCode(line[8]), "");
		var period = new Period(stringToDateArray(line[9]), stringToDateArray(line[10]), null, null, null, null, null, null, null, null, null, null);
		ciList[index++] = new ContentInformation(CRID_PREFIX + line[0], line[1], bd, null, period, null, SORT_INDEX_ASC, null);
	}
	return new PageInformation(lineList[0], ciList);
}

/**
 * ジャンルTSVへのURLを生成する処理
 * getGenresForGenre()，getGenresForRanking()，getGenresForComingEnd()，getGenresForNewArrival()から呼び出される。
 * 
 * @param genreType ジャンルの種類(ジャンル用、ランキング用、新着用、など)
 * @param child 親ジャンルかサブジャンルかを示す(ジャンル用TSVのみ)
 * @param age BMLから指定されたispid
 * @param age BMLから指定されたmode
 * @param age BMLから指定されたage
 * @return PageInformation
 */
function getGenreMenuUri(genreType, child, ispid, mode, age) {
	// パレンタル値生成
	var pare = age;
	if (20 <= age) {
		pare = 20;
	}
	// ジャンルTSVへのパス生成
	var path = genreType + "/" + ispid + "/" + mode + "/" + PARENTAL_MAP[pare] + "/";
	var fileName = "ROOT.tsv";
	
	// childにROOT以外が指定された場合はchildをサブジャンルTSV名とする。
	if (child != "ROOT") {
		fileName = child + ".tsv";
	}
	return path + fileName;
}

/**
 * 引数チェック処理
 * エラーであればエラーオブジェクトを生成してfalseを返す。
 * 
 * @param arg 引数の配列。
 * @param type 許容する文字数の配列。(typeのindexとargのindexは一対一)
 *            -1→チェック無し。0→0文字の場合エラーにする。1以上→指定された数値の文字数以外であればエラーにする。
 * @param apiId 機能ID(「XX-YY-ZZZZZZZZZ」のXX部分)
 * @return チェック結果。true→OK、false→NG
 */
function paramCheck(arg, type, apiId) {
	var ret = false;
	for (var i = 0; i < arg.length; i++) {
		if (type[i] < 0) {
			// チェック無し
			continue;
		} else if (type[i] == 0) {
			// nullチェック、空文字チェック
			if(arg[i] == null || arg[i].length == 0) {
				addError(new Error(apiId, "04", "000000000", ERRORMSG_PARAM));
				return ret;
			}
		} else {
			// nullチェック、桁数チェック
			if(arg[i] == null || arg[i].length != type[i]) {
				addError(new Error(apiId, "04", "000000000", ERRORMSG_PARAM));
				return ret;
			}
		}
	}
	return true;
}

/**
 * 応答電文のエラーチェック処理
 * 
 * 1 通信エラーチェック
 *   対向サーバへのHTTP通信が成功しているかチェックする。
 *     1-1 失敗の場合→エラーオブジェクトを生成してNULLを返却する。
 * 2 改行でパースし配列へ格納する。
 * 3 HEADチェックflagが0の場合、「2」の配列を返却し終了する。
 * 4 応答電文HEAD部チェック
 *   HEAD部をチェックする。
 *     4-1 正常の場合→改行でパースした配列を返す。
 *     4-2 異常の場合→エラーオブジェクトを生成してNULLを返却する。
 *
 * @param transmitTextDataOverIPの戻り値(配列)
 * @param HEADチェックflag：1→HEADチェック実行。0→通信エラーチェックのみ。
 * @param apiId：機能ID(「XX-YY-ZZZZ」のXX部分)
 * @param initial：エラータイプ(「XX-YY-ZZZZ」のZZZZの1文字目部分)。HEADチェックflagが0の場合はbrank
 * @return 改行でパースした配列(TSVヘッダ部とTSVボディー部のみ) or NULL
 */
function checkResponse(ret, h_chk_flag, apiId, initial) {
	
	// 1 通信エラーチェック
	if (ret[0] != 1 || ret[2] == null || ret[2].length < 1 || ret[1] != "200") {
		var resCode = ret[1];
		if (resCode == null) {
			resCode = "000";
		}
		// 通信エラー
		addError(new Error(apiId, "01", "000000" + resCode, ERRORMSG_HTTP));
		return null;
	}
	
	// HEADチェックフラグが0の場合は終了
	var lineList = ret[2].split("\r\n");
	if (h_chk_flag == 0) {
		return lineList;
	}
	
	// 4 応答電文HEAD部チェック
	var resultLine = lineList[0].split("=");
	if (resultLine[1] != RESULT_CODE_NORMAL) {
		var errType = "02";
		// 準正常の場合、エラータイプを変更。
		if (resultLine[1] == RESULT_CODE_WARNING) {
			errType = "05";
		// DRM_ID重複の場合、エラータイプを変更。
		} else if (resultLine[1] == RESULT_CODE_CONFLICTED_DRMID) {
			errType = "06";
		}
		
		// 対向サーバのエラーメッセージが空の場合、ECMAでメッセージを設定する。
		var errMessage = lineList[2].split("=")[1];
		if (errMessage == null || errMessage.length < 1) {
			errMessage = ERRORMSG_SERVER;
		}
		// 対向サーバエラー
		addError(new Error(
				apiId, 
				errType, 
				lineList[1].split("=")[1], 
				errMessage));
		return null;
	}
	// TSVヘッダ以降の配列を返却
	var resultArray = new Array(0);
	for (var i = 0; i < lineList.length; i++) {
		resultArray[i] = lineList[i+4];
	}
	return resultArray;
}

/**
 * 文字列に含まれる改行コードを置換する（"\n"を"\r\n"へ置換）
 * @param str 置換対象文字列
 * @return 置換後文字列
 */
function replaceLineCode(str) {
	if (str == null || str.length == 0) {
		return "";
	}
	return str.split("\n").join("\r\n");
}

/**
 * 指定されたDateオブジェクトの文字列を返す（YYYYMMDDHH形式）
 * @return 時刻（YYYYMMDDHH形式）
 */
function getDateFormat(date) {
	if (date == null) {
		return null;
	}
	var year = String(date.getFullYear());
	var month = String(date.getMonth() + 1);
	if (month.length == 1) {
		month = "0" + month;
	}
	var day = String(date.getDate());
	if (day.length == 1) {
		day = "0" + day;
	}
	var hours = String(date.getHours());
	if (hours.length == 1) {
		hours = "0" + hours;
	}
	return year + month + day + hours;
}

/**
 * YYYY-MM-DD-hh-mm-ddをスプリットし，parseIntされたnumberの配列（DateArray）で返却します．
 * @param text
 * @return numberの配列
 */
function stringToDateArray(text){
	if (text == null || text.length == 0) {
		return null;
	}
	var dateArray = text.split("-");
	for (var i = 0; i < dateArray.length; i++) {
		var temp_num = parseInt(dateArray[i], 10);
		if (isNaN(temp_num)) {
			return null;
		}
		dateArray[i] = temp_num;
	}
	return dateArray;
}

/**
 * 現在時刻が指定した日付内に含まれるかチェック
 * @param text1 開始日時(String:YYYY-MM-DD-hh-mm-SS形式)
 * @param text2 終了日時(String:YYYY-MM-DD-hh-mm-SS形式)
 * @return 期間内→true、期間外→false
 */
function checkValidityTerm(text1, text2) {
	var ret = false;
	if (text1 == null || text1.length == 0 || text2 == null || text2.length == 0) {
		return ret;
	}
	var text1Str = text1.split("-");
	var text2Str = text2.split("-");
	var now = new Date();
	var nowYear = String(now.getFullYear());
	var nowMonth = String(now.getMonth() + 1);
	if (nowMonth.length == 1) {
		nowMonth = "0" + nowMonth;
	}
	var nowDay = String(now.getDate());
	if (nowDay.length == 1) {
		nowDay = "0" + nowDay;
	}
	var nowHours = String(now.getHours());
	if (nowHours.length == 1) {
		nowHours = "0" + nowHours;
	}
	var nowMinutes = String(now.getMinutes());
	if (nowMinutes.length == 1) {
		nowMinutes = "0" + nowMinutes;
	}
	var nowSeconds = String(now.getSeconds());
	if (nowSeconds.length == 1) {
		nowSeconds = "0" + nowSeconds;
	}
	
	// 開始日時を年月日と時分秒に分割
	var start1 = parseInt(text1Str[0] + "" + text1Str[1] + "" + text1Str[2], 10);
	var start2 = parseInt(parseInt(text1Str[3], 10) + "" + text1Str[4] + "" + text1Str[5], 10);
	// 終了日時を年月日と時分秒に分割
	var end1 = parseInt(text2Str[0] + "" + text2Str[1] + "" + text2Str[2], 10);
	var end2 = parseInt(parseInt(text2Str[3], 10) + "" + text2Str[4] + "" + text2Str[5], 10);
	// 現在日時を年月日と時分秒に分割
	var now1 = parseInt(nowYear + "" + nowMonth + "" + nowDay, 10);
	var now2 = parseInt(parseInt(nowHours, 10) + "" + nowMinutes + "" + nowSeconds, 10);
	
	// 現在時刻が開始日時以上かチェック
	if (start1 > now1) {
		return ret;
	}
	if (start1 == now1) {
		if (start2 > now2) {
			return ret;
		}
	}
	
	// 現在時刻が終了日時以下かチェック
	if (end1 < now1) {
		return ret;
	}
	if (end1 == now1) {
		if (end2 < now2) {
			return ret;
		}
	}
	return true;
}

/**
 * レジデント関連の応答電文パース処理
 * @param 応答電文(body部のみ)
 * @return パース結果(key=valueの連想配列)
 */
function parseForRegident(lineList) {
	var obj = new Object();
	for (var i = 0; i < lineList.length; i++) {
		if (lineList[i] == null || lineList[i].length == 0) {
			continue;
		}
		var line = splitEx(lineList[i], "=");
		
		if (line[0] == "writeparam" || line[0] == "verifyparam" || line[0] == "verifykey") {
			// 右辺が$付きの場合
			var keyAndValue = splitEx(line[1], "$");
			obj[keyAndValue[0]] = keyAndValue[1];
		} else if (line[0] == "readparam" || line[0] == "requestparam") {
			// 右辺にパラメータ名が設定される場合(パラメータの有無自体に意味のあるデータ)
			obj[line[0] + line[1]] = "1";
		} else {
			// 右辺が$無しの場合
			obj[line[0]] = line[1];
		}
	}
	return obj;
}

/**
 * スプリット処理
 * @param str split対象の文字列
 * @param sep 区切り文字
 * @return 配列(要素数は2つ)
 */
function splitEx(str, sep) {
	if (str == null) {
		return null;
	}
	if ((sep == null) || (sep.length == 0)) {
		return new Array(str, "");
	}
	var arr = str.toString().split(sep);
	var key = arr[0];
	var valarr = new Array();
	for (var i = 1; i < arr.length; i++) {
		valarr[valarr.length] = arr[i];
	}
	var val = valarr.join(sep);
	return new Array(key, val);
}

/**
 * 渡された複数の日付の中から、未来の日付を取得します。
 * dateArraysの中で一番未来の日付を返します。
 * @param dateArrays 日付(配列)の配列
 * @return dateArraysの中で一番未来の日付
 */
function getMaxDate(dateArrays) {
	if (dateArrays == null || dateArrays.length == 0) {
		return null;
	}
	var tmpDate = null;
	for (var i = 0; i < dateArrays.length; i++) {
		if (dateArrays[i] == null) {
			continue;
		}
		if (tmpDate == null) {
			tmpDate = dateArrays[i];
			continue;
		}
		// 年が9999の場合、その日付を返す
		if (dateArrays[i][0] == "9999") {
			tmpDate = dateArrays[i];
			break;
		}
		// 年が大きい場合は入れ替え
		if (tmpDate[0] < dateArrays[i][0]) {
			tmpDate = dateArrays[i];
			continue;
		} else if (tmpDate[0] == dateArrays[i][0]) {
			// 年が同一で月が大きい場合は入れ替え
			if (tmpDate[1] < dateArrays[i][1]) {
				tmpDate = dateArrays[i];
				continue;
			} else if (tmpDate[1] == dateArrays[i][1]) {
				// 年月が同一で日が大きい場合は入れ替え
				if (tmpDate[2] < dateArrays[i][2]) {
					tmpDate = dateArrays[i];
					continue;
				} else if (tmpDate[2] == dateArrays[i][2]) {
					// 年月日が同一で時間が大きい場合は入れ替え
					if (tmpDate[3] < dateArrays[i][3]) {
						tmpDate = dateArrays[i];
						continue;
					} else if (tmpDate[3] == dateArrays[i][3]) {
						// 年月日時が同一で分が大きい場合は入れ替え
						if (tmpDate[4] < dateArrays[i][4]) {
							tmpDate = dateArrays[i];
							continue;
						} else if (tmpDate[4] == dateArrays[i][4]) {
							// 年月日時分が同一で秒が大きい場合は入れ替え
							if (tmpDate[5] < dateArrays[i][5]) {
								tmpDate = dateArrays[i];
								continue;
							}
						}
					}
				}
			}
		}
	}
	return tmpDate;
}

/**
 * 渡された複数の日付の中から、過去の日付を取得します。
 * dateArraysの中で一番過去の日付を返します。
 * @param dateArrays 日付(配列)の配列
 * @return dateArraysの中で一番過去の日付
 */
function getMinDate(dateArrays) {
	if (dateArrays == null || dateArrays.length == 0) {
		return null;
	}
	var tmpDate = null;
	for (var i = 0; i < dateArrays.length; i++) {
		if (dateArrays[i] == null) {
			continue;
		}
		if (tmpDate == null) {
			tmpDate = dateArrays[i];
			continue;
		}
		// 年が小さい場合は入れ替え
		if (tmpDate[0] > dateArrays[i][0]) {
			tmpDate = dateArrays[i];
			continue;
		} else if (tmpDate[0] == dateArrays[i][0]) {
			// 年が同一で月が小さい場合は入れ替え
			if (tmpDate[1] > dateArrays[i][1]) {
				tmpDate = dateArrays[i];
				continue;
			} else if (tmpDate[1] == dateArrays[i][1]) {
				// 年月が同一で日が小さい場合は入れ替え
				if (tmpDate[2] > dateArrays[i][2]) {
					tmpDate = dateArrays[i];
					continue;
				} else if (tmpDate[2] == dateArrays[i][2]) {
					// 年月日が同一で時間が小さい場合は入れ替え
					if (tmpDate[3] > dateArrays[i][3]) {
						tmpDate = dateArrays[i];
						continue;
					} else if (tmpDate[3] == dateArrays[i][3]) {
						// 年月日時が同一で分が小さい場合は入れ替え
						if (tmpDate[4] > dateArrays[i][4]) {
							tmpDate = dateArrays[i];
							continue;
						} else if (tmpDate[4] == dateArrays[i][4]) {
							// 年月日時分が同一で秒が小さい場合は入れ替え
							if (tmpDate[5] > dateArrays[i][5]) {
								tmpDate = dateArrays[i];
								continue;
							}
						}
					}
				}
			}
		}
	}
	return tmpDate;
}

/**
 * 応答電文中でキー名末尾に数字のつく値(例:mclicense_list_0)を、
 * 配列形式で取得します。
 *
 * @param ret 応答電文をパースしたオブジェクト
 * @param key 取得するキー名(末尾につく数値の前まで)
 * @param startIndex 開始インデックス(このインデックスを含む)
 * @param lastIndex 終了インデックス(このインデックスを含む)
 * @return 配列形式に変換した値
 */
function parseArrayValue(ret, key, startIndex, lastIndex) {
	var licenseList = new Array();
	var index = 0;
	for (var i = startIndex; i <= lastIndex; i++) {
		var license = ret[key + i.toString()];
		if (license != null && license.length > 0) {
			licenseList[index++] = ret[key + i.toString()];
		}
	}
	
	return licenseList;
}

/**
 * 検索要求パラメータの特殊文字をエスケープします.
 * エスケープ対象となる特殊文字は "=", "\t" です.
 *
 * @param requestParam 検索要求パラメータ
 * @return 特殊文字をエスケープした文字列
 */
function escapeRequestParam(requestParam) {
	requestParam = requestParam.split("=").join("%3D");
	requestParam = requestParam.split("\t").join("%09");
	return requestParam;
}


////////////////////////// STEP3.0関数群(ここまで) ////////////////////////////////


//////////////////////////    エラー関数群    /////////////////////////////////

/**
 * エラー情報を保持します．
 *
 * @param apiId 関数ごとに振られたID
 * @param type エラータイプ
 * @param code エラーコード
 * @param message 対向サーバのメッセージ
 * @param serverCode 対向サーバから送られた9桁のエラーコード
 */
function Error(apiId, type, code, message) {
  this.apiId = apiId;
  
  if (code.charAt(0) == "A") {
    this.type = "1" + type.substring(1);
  } else if (code.charAt(0) == "B") {
    this.type = "2" + type.substring(1);
  } else if (code.charAt(0) == "P") {
    this.type = "3" + type.substring(1);
  } else if (code.charAt(0) == "R") {
    this.type = "4" + type.substring(1);
  } else {
    this.type = type;
  }
  
  this.code = code.substring(1, 9);
  this.message = message;
  this.serverCode = code;
}

/**
 * エラー配列を取得します．
 */
function getErrors() {
  return g_errors;
}

/**
 * エラー配列にエラーを追加します．
 *
 * @param error エラー情報
 */
function addError(error) {
  g_errors[g_errors.length] = error;
}

//////////////////////////    ログ関数群    /////////////////////////////////

/**
 * ログメッセージをサーバに送信します．(デバグ用．最終リリースでは削除します)
 *
 * @param level ログレベル "FATAL", "INFO", "DEBUG", "ERROR"のいずれかを指定
 * @param code メッセージコード
 * @param message ログメッセージ
 * @return なし
 */
function sendLogs(level, code, message) {
  return;
}

/////////////////////////    スタブ関数群    ////////////////////////////////

// [5/13 modify] contentDetailをNullにする処理を削除しました。(プレミアム解約一覧表示のため)
//
// リスト系ContentInformation配列取得
function tsvParseForCIList(tsv) {
  var ci = tsvParseForCI(tsv);
  // ci.contentDetail = null;		// プレミアム解約一覧表示のため削除
  if (ci.broadCastEvent.serviceId.length == 0) {
    ci.broadCastEvent = null;
  }
  return ci;
}

// ContentInformationのパーサ
function tsvParseForCI(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	
	i = 77;
	var karaoke = new KaraokeInformation(t[i++], t[i++], t[i++], t[i++], t[85]);

	i = 47;
	var purArray = new Array();
    var pur1 = new PurchaseLicense(t[i++], t[i++], t[i++], t[i++], t[i++], t[i++],
                 stringToDateArray(t[i++]), stringToDateArray(t[i++]),
                 stringToDateArray(t[i++]), stringToDateArray(t[i++]),
                 t[i++], t[i++], t[i++], t[i++], stringToDateArray(t[i++]));
    var pur2 = new PurchaseLicense(t[i++], t[i++], t[i++], t[i++], t[i++], t[i++],
                 stringToDateArray(t[i++]), stringToDateArray(t[i++]),
                 stringToDateArray(t[i++]), stringToDateArray(t[i++]),
                 t[i++], t[i++], t[i++], t[i++], stringToDateArray(t[i++]));
    if ((pur1.licenseId != null) && (pur1.licenseId.length != 0)) {
		purArray[0] = pur1;
    }
    if ((pur2.licenseId != null) && (pur2.licenseId.length != 0)) {
		purArray[1] = pur2;
    }
	// i = 43;
	// var activel = new ActiveLicense(t[i++], stringToDateArray(t[i++]),
    //                                  stringToDateArray(t[i++]), t[i++], t[84]);
    i = 44;
	var activel = new ActiveLicense("", stringToDateArray(t[i++]),
                                     stringToDateArray(t[i++]), t[i++]);
    if(activel.licenseStart==null) activel=null;
	// i = 40;
	// var detail = new ContentDetail(t[i++], t[i++], t[i++], activel, purArray, null, t[0]);
	i = 40;
	var detail = new ContentDetail(t[i++], t[i++], t[i++], activel, purArray, null, t[0], t[43], t[84]);
	
	i = 36;
	var bevent = new BroadCastEvent(t[i++], t[i++], t[i++], t[i++]);
	i = 24;
	var period = new Period(stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]), stringToDateArray(t[i++]));
	i = 13;
	var icon = new Icon(t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[i++]);
	i = 3;
	var basicd = new BasicDescription(t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[i++], t[83]);
	i = 0;
	
	//var ci = new ContentInformation(t[i++], t[i++], basicd, icon, period, detail, t[i++], bevent, karaoke);
	var ci = new ContentInformation(t[i++], t[i++], basicd, icon, period, detail, t[i++], bevent);
	
	i = 81;
	ci.extraObject[EO_KEY_NOD] = t[i++];
	ci.extraObject[EO_KEY_REGULATION_URL] = t[i++];
	
	return ci;
}

// GenreInformationのパーサ
function tsvParseForGenre(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new GenreInformation(t[i++],t[i++],t[i++],t[i++]);
}

// PurchaseLicenseのパーサ
function tsvParseForPLicense(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new PurchaseLicense(t[i++],t[i++],t[i++],t[i++],t[i++],t[i++],
                               stringToDateArray(t[i++]),stringToDateArray(t[i++]),
                               stringToDateArray(t[i++]),stringToDateArray(t[i++]),
                               t[i++],t[i++], t[i++], t[i++], stringToDateArray(t[i++]));
}

function tsvParseForLongSynopsis(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new LongSynopsis(t[i++],t[i++]);
}

// ResultLoginのパーサ
function tsvParseForResLogin(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new ResultLogin(t[i++]);
}

// ParseForResLoginStartupのパーサ
function tsvParseForResLoginStartup(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new ResultLoginStartup(t[i++],t[i++],t[i++],t[i++],t[i++],t[i++],t[i++],t[i++],t[i++]);
}

// ResultContractオブジェクト生成のパーサ
function tsvParseForResCnt(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new ResultContract(t[i++], t[i++]);
}

// ResultContractInformationオブジェクト生成のパーサ
function tsvParseForResCntInf(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new ResultContractInformation(t[i++],t[i++],t[i++],t[i++],t[i++]);
}

// ResultCustomerIDオブジェクト生成のパーサ
function tsvParseForResCustmID(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new ResultCustomerId(t[i++],t[i++],t[i++],t[i++],
						t[i++],t[i++],t[i++],t[i++],t[i++],t[i++].split("/"));
}

// ResultActiveLicenseオブジェクト生成のパーサ
function tsvParseForResActLic(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new ResultActiveLicense(t[i++],t[i++],t[i++]);
}

/**
 * YYYY-MM-DD-hh-mm-ddをスプリットし，配列（DateArray）で返却します．
 *
 */
function stringToDateArray(text){
	if (text == null) {
		return null;
	}
    var sarray = String(text).split("-");
    var narray = new Array();
    if (sarray.length != 6) {
        return null;
    }
    for (var i = 0; i < sarray.length; i++) {
        var num = parseInt(sarray[i],10);
        if (isNaN(num)) {
            return null;
        }
        narray[narray.length] = num;
    }
	return narray;
}

function getZeroNum(arg, order) {
	var num = arg;
	if (isNaN(arg)) {
		num = 0;
	}
	var result = "" + arg;
	for (var i = 0; i < order; i++) {
		if (result.length >= order) {
			return result;
		}
		var result = "0" + result;
	}
	return result;
}

function getMaxLines(urlPrefix, page, numPerTsv, length, total) {

	var execNum = length / numPerTsv;
	var totalNum = total / numPerTsv;
	var realOffset = page * execNum;
	if (total % numPerTsv != 0) {
		totalNum ++;
	}
	if (realOffset + execNum > totalNum) {
		execNum = totalNum - realOffset;
	}
	var resultList = new Array();
	var index = 0;
	for (var i = realOffset; i < realOffset + execNum ; i++) {
		var ret = browser.transmitTextDataOverIP(urlPrefix + "."
		 + getZeroNum(i, 2), null, "EUC-JP");
		// レコード単位で配列に格納
		var records = ret[2].split("\r\n");
		// レコード毎にパースしつつオブジェクトを生成
		for (var j = 0; j < records.length ; j++) {
			if (records[j].length != 0) {
				resultList[index] = tsvParseForCIList(records[j]);
				index ++ ;
			}
		}
	}
	return new PageInformation(total, resultList);
}

function getOneContent(urlPrefix, index) {
	var ret = browser.transmitTextDataOverIP(urlPrefix + "."
		 + getZeroNum(index, 2), null, "EUC-JP");
	// レコード単位で配列に格納
	var records = ret[2].split("\r\n");
	return tsvParseForCI(records[0]);
}

function getPL(url) {
	// TSVファイルを要求
	var ret = browser.transmitTextDataOverIP(url, null, "EUC-JP");

	// レコード単位で配列に格納
	var tsvList = ret[2].split("\r\n");

	var result = new Array();

	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForPLicense(tsvList[i]);
	}
	return result;
}

// ★Step1.5用

// 購入確認用コンテンツ指定
function getBuyConfirm(urlPrefix, displayType) {
	var ret = browser.transmitTextDataOverIP(urlPrefix
		 + displayType + ".tsv" , null, "EUC-JP");
	var records = ret[2].split("\r\n");
	return tsvParseForBuyConfirm(records[0]);
}

// BuyConfirmオブジェクト生成のパーサ
function tsvParseForBuyConfirm(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	var licenses = null;
;
	if (t[9].length != 0) {
		licenses = t[9].split("/");
	}
	return new ResultBuyConfirm(t[i++], t[i++], t[i++], t[i++], t[i++],
									t[i++], t[i++], t[i++], t[i++],licenses, t[10]);
}

// 購入完了用コンテンツ指定
function getBuyLicense(urlPrefix, displayType) {
	var ret = browser.transmitTextDataOverIP(urlPrefix
		 + displayType + ".tsv" , null, "EUC-JP");
	var records = ret[2].split("\r\n");
	return tsvParseForBuyLicense(records[0]);
}

// BuyLicenseオブジェクト生成のパーサ
function tsvParseForBuyLicense(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	var licenses = null;
;
	if (t[2].length != 0) {
		licenses = t[2].split("/");
	}
	return new ResultBuyLicense(t[i++], t[i++], licenses);
}

// VOD購入履歴リストコンテンツ指定
function getBuyListCI(urlPrefix, id, page) {
	var ret = browser.transmitTextDataOverIP(urlPrefix + 
		id + ".tsv." + getZeroNum(page, 2) , null, "EUC-JP");
	var tsvList = ret[2].split("\r\n");
	
	var result = new Array();
	
	// レコード毎にパースしつつオブジェクトを生成
	for (var i = 0; i < tsvList.length; i++) {
		result[i] = tsvParseForBuyListCI(tsvList[i]);
	}
	return result;
}

// BuyListオブジェクト生成のパーサ
function tsvParseForBuyListCI(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	
	var purArray = new Array();
	var bd = new BasicDescription("", "", "", "", "", "", t[4], t[5], "", "", "");
	purArray[0] = new PurchaseLicense( t[1], "", "", t[2], "", "", null, null, null, null, "", "", t[3], t[6], stringToDateArray(t[0]) );
	var cd = new ContentDetail( 1, 0, 0, null, purArray, null, "", "", "");
	return new ContentInformation("", null, bd, null, null, cd, "", null);
}

// 解約確認用コンテンツ指定
function getCancelConfirm(urlPrefix, licenseType) {
	var ret = browser.transmitTextDataOverIP(urlPrefix
		 + licenseType + ".tsv" , null, "EUC-JP");
	var records = ret[2].split("\r\n");
	return tsvParseForCancelConfirm(records[0]);
}

// CancelConfirmオブジェクト生成のパーサ
function tsvParseForCancelConfirm(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	var licenses = null;
;
	if (t[4].length != 0) {
		licenses = t[4].split("/");
	}
	return new ResultCancelConfirm(t[i++], t[i++], t[i++], t[i++], licenses);
}

// 解約用コンテンツ指定
function getCancelLicense(urlPrefix, licenseType) {
	var ret = browser.transmitTextDataOverIP(urlPrefix
		 + licenseType + ".tsv", null, "EUC-JP");
	var records = ret[2].split("\r\n");
	return tsvParseForCancelLicense(records[0]);
}

// BuyLicenseオブジェクト生成のパーサ
function tsvParseForCancelLicense(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new ResultCancelLicense(t[i++]);
}

// ResultSubscribeオブジェクト生成のパーサ
function tsvParseForResultSubscribe(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	var licenses = null;
;
	if (t[9].length != 0) {
		licenses = t[9].split("/");
	}
	var linetype = t[10];
	return new ResultSubscribe(t[i++],t[i++],t[i++],t[i++],
						t[i++],t[i++],t[i++],t[i++],t[i++],
						licenses, linetype);
}

// 規約情報格納用パーサ
function tsvParseForRegulationInformation(tsv) {
	var t = tsv.split("\t");
	var i = 0;
	return new RegulationInformation(t[i++],t[i++]);
}


function searchKaraokeReservationList(genre, sort, page, ispid, mode, age) {
	return getMaxLines(STUB_PATH + "searchKaraokeReservationList.tsv",
						 page, 9 ,KARAOKE_LIST_NUM_PER_PAGE, KARAOKE_CONTENT_TOTAL);
}

function searchVODContentDetailList(){
	var result = new Array();
	for (var i = 0; i < 9; i++){
		result[i] = getOneContent(STUB_PATH + "getVODContentDetail.tsv",i);
	}
	return new PageInformation(9 , result);
}

